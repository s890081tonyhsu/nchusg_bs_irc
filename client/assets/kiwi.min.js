!function(e,t){function n(e){var t,n,i,s,a,o;return t=Math.floor(e/3600),s=e%3600,n=Math.floor(s/60),a=s%60,i=Math.ceil(a),o={h:t,m:n,s:i}}function i(){this.recursive_depth=3,this.aliases={},this.vars={version:1};var e=0;this.processInput=function(e){var t,n=e||[],i=this.aliases[n[0]],s="",a=[];if(!i)return e;i=i.split(" "),t=i.length;for(var o=0;t>o;o++)if(s=i[o],"$"===s[0])if(isNaN(s[1]))"undefined"==typeof this.vars[s.substr(1)]||a.push(this.vars[s.substr(1)]);else{var c=s.match(/\$(\d+)(\+)?(\d+)?/);if(!c||!n[c[1]])continue;"+"===c[2]&&c[3]?a=a.concat(n.slice(parseInt(c[1],10),parseInt(c[1],10)+parseInt(c[3],10))):"+"===c[2]?a=a.concat(n.slice(parseInt(c[1],10))):a.push(n[parseInt(c[1],10)])}else a.push(s);return a},this.process=function(t){t=t||"";var n=t.split(" ");return e++,e>=this.recursive_depth?(e--,t):(this.aliases[n[0]]&&(n=this.processInput(n),this.aliases[n[0]]&&(n=this.process(n.join(" ")).split(" "))),e--,n.join(" "))}}function s(e,t,n){function i(e,t,n){var i;return 0>n?n+=1:n>1&&(n-=1),i=1>6*n?e+6*(t-e)*n:1>2*n?t:2>3*n?e+6*(t-e)*(2/3-n):e,255*i}var s,a,o,c,l,r;return t/=100,n/=100,0==t?c=l=r=255*n:(a=.5>=n?n*(t+1):n+t-n*t,s=2*n-a,o=e/360,c=i(s,a,o+1/3),l=i(s,a,o),r=i(s,a,o-1/3)),[c,l,r]}function a(e){e=e.replace(/%C(\d)/gi,function(e,t){return String.fromCharCode(3)+t.toString()});var t={B:"",I:"",U:"",O:""};return e=e.replace(/%([BIUO])/gi,function(e,n){return"undefined"!=typeof t[n.toUpperCase()]?t[n.toUpperCase()]:void 0})}function o(e){"use strict";var t,n="",i="",s={bold:!1,italic:!1,underline:!1,colour:!1},a=function(){var e,t="";return s.bold||s.italic||s.underline||s.colour?(t+=s.bold?"font-weight: bold; ":"",t+=s.italic?"font-style: italic; ":"",t+=s.underline?"text-decoration: underline; ":"",s.colour&&(e=s.colour.split(","),t+="color: "+e[0]+(e[1]?"; background-color: "+e[1]+";":"")),'<span class="format_span" style="'+t+'">'):""},o=function(e){var t=/^\x03(([0-9][0-9]?)(,([0-9][0-9]?))?)/;return t.exec(e)},c=function(e){switch(parseInt(e,10)){case 0:return"#FFFFFF";case 1:return"#000000";case 2:return"#000080";case 3:return"#008000";case 4:return"#FF0000";case 5:return"#800040";case 6:return"#800080";case 7:return"#FF8040";case 8:return"#FFFF00";case 9:return"#80FF00";case 10:return"#008080";case 11:return"#00FFFF";case 12:return"#0000FF";case 13:return"#FF55FF";case 14:return"#808080";case 15:return"#C0C0C0";default:return null}},l=0,r=[];for(l=0;l<e.length;l++)switch(e[l]){case"":(s.bold||s.italic||s.underline||s.colour)&&(n+=i+"</span>"),s.bold=!s.bold,i=a();break;case"":(s.bold||s.italic||s.underline||s.colour)&&(n+=i+"</span>"),s.italic=!s.italic,i=a();break;case"":(s.bold||s.italic||s.underline||s.colour)&&(n+=i+"</span>"),s.underline=!s.underline,i=a();break;case"":(s.bold||s.italic||s.underline||s.colour)&&(n+=i+"</span>"),t=o(e.substr(l,6)),t?(l+=t[1].length,r[0]=c(t[2]),t[4]&&(r[1]=c(t[4])),s.colour=r.join(",")):s.colour=!1,i=a();break;case"":(s.bold||s.italic||s.underline||s.colour)&&(n+=i+"</span>"),s.bold=s.italic=s.underline=s.colour=!1;break;default:s.bold||s.italic||s.underline||s.colour?i+=e[l]:n+=e[l]}return(s.bold||s.italic||s.underline||s.colour)&&(n+=i+"</span>"),n}function c(e){return e=e||new Date,e.toLocaleDateString()+", "+e.getHours().toString()+":"+e.getMinutes().toString()+":"+e.getSeconds().toString()}function l(e){return e.replace(/[\[\\\^\$\.\|\?\*\+\(\)]/g,"\\$&")}function r(e){var t,n=e.split(" "),i=[],s=function(e,t){i.push('<i class="emoticon '+t+'">'+e+"</i>")};for(t=0;t<n.length;t++)switch(n[t]){case":)":s(":)","smile");break;case":(":s(":(","sad");break;case":3":s(":3","lion");break;case";3":s(";3","winky_lion");break;case":s":case":S":s(":s","confused");break;case";(":case";_;":s(";(","cry");break;case";)":s(";)","wink");break;case";D":s(';D"',"wink_happy");break;case":P":case":p":s(":P","tongue");break;case"xP":s("xP","cringe_tongue");break;case":o":case":O":case":0":s(":o","shocked");break;case":D":s(":D","happy");break;case"^^":case"^.^":s("^^,","eyebrows");break;case"&lt;3":s("<3","heart");break;case"&gt;_&lt;":case"&gt;.&lt;":s(">_<","doh");break;case"XD":case"xD":s("xD","big_grin");break;case"o.0":case"o.O":s("o.0","wide_eye_right");break;case"0.o":case"O.o":s("0.o","wide_eye_left");break;case":\\":case"=\\":case":/":case"=/":s(":\\","unsure");break;default:i.push(n[t])}return i.join(" ")}var h={};h.model={},h.view={},h.applets={},h.global={settings:t,plugins:t,utils:t,user:t,server:t,channels:t,components:{EventComponent:function(e,t){function n(e,n){"all"!==t&&(n=e.event_data,e=e.event_name),this.trigger(e,n)}t=t||"all",_.extend(this,Backbone.Events),this._source=e,e.on(t,n,this),this.dispose=function(){e.off(t,n),this.off(),delete this.event_source}},Network:function(e){var t;"undefined"!=typeof e&&(t="connection:"+e.toString());var n=new this.EventComponent(h.gateway,t),i={kiwi:"kiwi",raw:"raw",kick:"kick",topic:"topic",part:"part",join:"join",action:"action",ctcp:"ctcp",notice:"notice",msg:"privmsg",changeNick:"changeNick"};return _.each(i,function(t,i){n[i]=function(){var n=t,i=Array.prototype.slice.call(arguments,0);return i.unshift(e),h.gateway[n].apply(h.gateway,i)}}),n},ControlInput:function(){var e=new this.EventComponent(h.app.controlbox),t={processInput:"run",addPluginIcon:"addPluginIcon"};return _.each(t,function(t,n){e[n]=function(){var e=t;return h.app.controlbox[e].apply(h.app.controlbox,arguments)}}),e}},start:function(e,t){var n,i;e=e||{},n=function(n,i,s){h.global.i18n=n?new Jed({locale_data:n,domain:s.getResponseHeader("Content-Language")}):new Jed,h.app=new h.model.Application(e),e.kiwi_server&&(h.app.kiwi_server=e.kiwi_server),h.app.start(),h.global.plugins=new h.model.PluginManager,t&&t()},h.global.settings=h.model.DataStore.instance("kiwi.settings"),h.global.settings.load(),window.document.title=e.server_settings.client.window_title||"NCHU IRC Client",i=h.global.settings.get("locale"),i?$.getJSON(e.base_path+"/assets/locales/"+i+".json",n):$.getJSON(e.base_path+"/assets/locales/magic.json",n)}},"undefined"!=typeof e?e.kiwi=h.global:h.global,h.model.Application=function(){var e=null,n=function(){function n(e){var t=e.command+" "+e.params.join(" ");console.log("RAW: "+t),h.gateway.raw(null,t)}function i(){}function s(t){var n,i;i=t.params.join(" ").split(","),n=e.connections.active_connection.createAndJoinChannels(i),n.length&&n[n.length-1].view.show()}function o(t){var n,i,s;n=t.params[0],t.params.shift(),i=t.params.join(" "),s=e.connections.active_connection.panels.getByName(n),s||(s=new h.model.Query({name:n}),e.connections.active_connection.panels.add(s)),s&&s.view.show(),i&&(e.connections.active_connection.gateway.msg(s.get("name"),i),s.addMsg(h.app.connections.active_connection.get("nick"),i))}function c(t){var n,i=t.params[0],s=e.connections.active_connection.panels.getByName(i)||e.panels().server;t.params.shift(),n=a(t.params.join(" ")),s.addMsg(h.app.connections.active_connection.get("nick"),n),h.gateway.privmsg(null,i,n)}function l(e){if(!h.app.panels().active.isServer()){var t=h.app.panels().active;t.addMsg("","* "+h.app.connections.active_connection.get("nick")+" "+e.params.join(" "),"action"),h.gateway.action(null,t.get("name"),e.params.join(" "))}}function r(e){0===e.params.length?h.gateway.part(null,h.app.panels().active.get("name")):_.each(e.params,function(e){h.gateway.part(null,e)})}function p(t){var n;0!==t.params.length&&(e.isChannelName(t.params[0])?(n=t.params[0],t.params.shift()):n=h.app.panels().active.get("name"),h.gateway.topic(null,n,t.params.join(" ")))}function d(e){var t;e.params.length<=1||(t=e.params[0],e.params.shift(),h.gateway.notice(null,t,e.params.join(" ")))}function g(e){var t=e.params.join(" ");h.gateway.raw(null,t)}function u(e){var t,n=h.app.panels().active;n.isChannel()&&0!==e.params.length&&(t=e.params[0],e.params.shift(),h.gateway.kick(null,n.get("name"),t,e.params.join(" ")))}function m(){h.app.panels().active.isServer()||h.app.panels().active.isApplet()||h.app.panels().active.clearMessages&&h.app.panels().active.clearMessages()}function f(e){var t,n;e.params.length<2||(t=e.params[0],e.params.shift(),n=e.params[0],e.params.shift(),h.gateway.ctcp(null,!0,n,t,e.params.join(" ")))}function v(){var e=h.model.Applet.loadOnce("kiwi_settings");e.view.show()}function w(){var e=h.model.Applet.loadOnce("kiwi_script_editor");e.view.show()}function k(e){if(e.params[0]){var t=new h.model.Applet;if(e.params[1])t.load(e.params[0],e.params[1]);else{if(!h.applets[e.params[0]])return h.app.panels().server.addMsg("",h.global.i18n.translate("client_models_application_applet_notfound").fetch(e.params[0])),void 0;t.load(new h.applets[e.params[0]])}h.app.connections.active_connection.panels.add(t),t.view.show()}}function b(e){var t,n;e.params[0]&&h.app.panels().active.isChannel()&&(t=e.params[0],n=h.app.panels().active.get("name"),h.app.connections.active_connection.gateway.raw("INVITE "+t+" "+n),h.app.panels().active.addMsg("","== "+t+" has been invited to "+n,"action"))}function y(e){var t;e.params[0]?t=e.params[0]:h.app.panels().active.isQuery()&&(t=h.app.panels().active.get("name")),t&&h.app.connections.active_connection.gateway.raw("WHOIS "+t+" "+t)}function C(e){var t;e.params[0]?t=e.params[0]:h.app.panels().active.isQuery()&&(t=h.app.panels().active.get("name")),t&&h.app.connections.active_connection.gateway.raw("WHOWAS "+t)}function x(e){e.params[0]?h.gateway.setEncoding(null,e.params[0],function(t){t?h.app.panels().active.addMsg("",h.global.i18n.translate("client_models_application_encoding_changed").fetch(e.params[0])):h.app.panels().active.addMsg("",h.global.i18n.translate("client_models_application_encoding_invalid").fetch(e.params[0]))}):(h.app.panels().active.addMsg("",h.global.i18n.translate("client_models_application_encoding_notspecified").fetch()),h.app.panels().active.addMsg("",h.global.i18n.translate("client_models_application_encoding_usage").fetch()))}function M(n){var i,s,a,o,c,l;return n.params[0]?(n.params[0].indexOf(":")>0?(l=n.params[0].split(":"),i=l[0],s=l[1],o=n.params[1]||t):(i=n.params[0],s=n.params[1]||6667,o=n.params[2]||t),"+"===s.toString()[0]?(a=!0,s=parseInt(s.substring(1),10)):a=!1,s=s||6667,c=h.app.connections.active_connection.get("nick"),h.app.panels().active.addMsg("",h.global.i18n.translate("client_models_application_connection_connecting").fetch(i,s.toString())),h.gateway.newConnection({nick:c,host:i,port:s,ssl:a,password:o},function(e){e&&h.app.panels().active.addMsg("",h.global.i18n.translate("client_models_application_connection_error").fetch(i,s.toString(),e.toString()))}),void 0):(l=new h.view.MenuBox(h.global.i18n.translate("client_models_application_connection_create").fetch()),l.addItem("new_connection",(new h.model.NewConnection).view.$el),l.show(),l.$el.offset({top:e.view.$el.height()/2-l.$el.height()/2,left:e.view.$el.width()/2-l.$el.width()/2}),void 0)}this.view=null,this.message=null,this.kiwi_server=null,this.initialize=function(t){e=this,t[0].container&&this.set("container",t[0].container),this.set("base_path",t[0].base_path?t[0].base_path:"/kiwi"),this.set("settings_path",t[0].settings_path?t[0].settings_path:this.get("base_path")+"/assets/settings.json"),this.server_settings=t[0].server_settings||{},this.translations=t[0].translations||{},this.detectKiwiServer(),this.server_settings&&this.server_settings.client&&this.server_settings.client.settings&&this.applyDefaultClientSettings(this.server_settings.client.settings)},this.start=function(){h.gateway=new h.model.Gateway,this.bindGatewayCommands(h.gateway),this.initializeClient(),this.initializeGlobals(),this.view.barsHide(!0),this.showIntialConenctionDialog()},this.detectKiwiServer=function(){this.kiwi_server="file:"===window.location.protocol?"http://localhost:7778":window.location.protocol+"//"+window.location.host},this.showIntialConenctionDialog=function(){var e=new h.model.NewConnection;this.populateDefaultServerSettings(e),e.view.$el.addClass("initial"),this.view.$el.find(".panel_container:first").append(e.view.$el);var t=$($("#tmpl_new_connection_info").html().trim());t.html()&&(e.view.infoBoxSet(t),e.view.infoBoxShow()),setTimeout(function(){e.view.$el.find(".nick").select()},0);var n=function(){e.view.$el.slideUp(function(){e.view.dispose(),e=null,h.gateway.off("onconnect",n)})};h.gateway.on("onconnect",n)},this.initializeClient=function(){this.view=new h.view.Application({model:this,el:this.get("container")}),this.connections=new h.model.NetworkPanelList,this.applet_panels=new h.model.PanelList,this.applet_panels.view.$el.addClass("panellist applets"),this.view.$el.find(".tabs").append(this.applet_panels.view.$el),this.controlbox=new h.view.ControlBox({el:$("#kiwi .controlbox")[0]}),this.bindControllboxCommands(this.controlbox),this.topicbar=new h.view.TopicBar({el:this.view.$el.find(".topic")[0]}),new h.view.AppToolbar({el:h.app.view.$el.find(".toolbar .app_tools")[0]}),this.message=new h.view.StatusMessage({el:this.view.$el.find(".status_message")[0]}),this.resize_handle=new h.view.ResizeHandler({el:this.view.$el.find(".memberlists_resize_handle")[0]}),this.view.doLayout()},this.initializeGlobals=function(){h.global.connections=this.connections,h.global.panels=this.panels,h.global.panels.applets=this.applet_panels,h.global.components.Applet=h.model.Applet,h.global.components.Panel=h.model.Panel},this.applyDefaultClientSettings=function(e){_.each(e,function(e,t){"undefined"==typeof h.global.settings.get(t)&&h.global.settings.set(t,e)})},this.populateDefaultServerSettings=function(e){var t,n,i={nick:"",server:"",port:6667,ssl:!1,channel:"#chat",channel_key:""};this.server_settings.client&&(this.server_settings.client.nick&&(i.nick=this.server_settings.client.nick),this.server_settings.client.server&&(i.server=this.server_settings.client.server),this.server_settings.client.port&&(i.port=this.server_settings.client.port),this.server_settings.client.ssl&&(i.ssl=this.server_settings.client.ssl),this.server_settings.client.channel&&(i.channel=this.server_settings.client.channel),this.server_settings.client.channel_key&&(i.channel_key=this.server_settings.client.channel_key)),getQueryVariable("nick")&&(i.nick=getQueryVariable("nick")),window.location.hash&&(i.channel=window.location.hash),t=window.location.pathname.toString().replace(this.get("base_path"),"").split("/"),t.length>0&&(t.shift(),t.length>0&&t[0]&&(n=t[0].substr(0,7).toLowerCase(),"ircs%3a"===n||"irc%3a"===n.substr(0,6)?(t[0]=decodeURIComponent(t[0]),n=/^irc(s)?:(?:\/\/?)?([^:\/]+)(?::([0-9]+))?(?:(?:\/)([^\?]*)(?:(?:\?)(.*))?)?$/.exec(t[0]),n&&("undefined"!=typeof n[1]&&(i.ssl=!0,6667===i.port&&(i.port=6697)),i.server=n[2],"undefined"!=typeof n[3]&&(i.port=n[3]),"undefined"!=typeof n[4]&&(i.channel="#"+n[4],"undefined"!=typeof n[5]&&(i.channel_key=n[5]))),t=[]):(t[0].search(/:/)>0?(i.port=t[0].substring(t[0].search(/:/)+1),i.server=t[0].substring(0,t[0].search(/:/)),"+"===i.port[0]?(i.port=parseInt(i.port.substring(1),10),i.ssl=!0):i.ssl=!1):i.server=t[0],t.shift())),t.length>0&&t[0]&&(i.channel="#"+t[0],t.shift())),this.server_settings&&this.server_settings.connection&&(this.server_settings.connection.server&&(i.server=this.server_settings.connection.server),this.server_settings.connection.port&&(i.port=this.server_settings.connection.port),this.server_settings.connection.ssl&&(i.ssl=this.server_settings.connection.ssl),this.server_settings.connection.channel&&(i.channel=this.server_settings.connection.channel),this.server_settings.connection.channel_key&&(i.channel_key=this.server_settings.connection.channel_key),this.server_settings.connection.nick&&(i.nick=this.server_settings.connection.nick)),i.nick=i.nick.replace("?",Math.floor(1e5*Math.random()).toString()),getQueryVariable("encoding")&&(i.encoding=getQueryVariable("encoding")),e.view.populateFields(i)},this.panels=function(){var e=function(e){var t;switch(e=e||"connections"){case"connections":t=this.connections.panels();break;case"applets":t=this.applet_panels.models}return t.active=this.connections.active_panel,t.server=this.connections.active_connection?this.connections.active_connection.panels.server:null,t};return _.extend(e,Backbone.Events),e}(),this.bindGatewayCommands=function(e){var t=this;e.on("onconnect",function(){t.view.barsShow()}),function(){var n=0,i=!1;e.on("disconnect",function(){if(i=!e.disconnect_requested){var s=h.global.i18n.translate("client_models_application_reconnecting").fetch()+"...";t.message.text(s,{timeout:1e4})}t.view.$el.removeClass("connected"),h.app.connections.forEach(function(e){e.panels.server.addMsg("",s,"action quit"),e.panels.forEach(function(e){e.isChannel()&&e.addMsg("",s,"action quit")})}),n=1}),e.on("reconnecting",function(e){var t=h.global.i18n.translate("client_models_application_reconnect_in_x_seconds").fetch(e.delay/1e3)+"...";h.app.connections.forEach(function(e){e.panels.server.addMsg("",t,"action quit")})}),e.on("onconnect",function(){if(t.view.$el.addClass("connected"),1===n){if(i){var e=h.global.i18n.translate("client_models_application_reconnect_successfully").fetch()+":)";t.message.text(e,{timeout:5e3})}h.app.connections.forEach(function(t){t.panels.server.addMsg("",e,"action join"),t.panels.forEach(function(t){t.isChannel()&&t.addMsg("",e,"action join")})}),n=0}})}(),e.on("kiwi:reconfig",function(){$.getJSON(t.get("settings_path"),function(e){t.server_settings=e.server_settings||{},t.translations=e.translations||{}})}),e.on("kiwi:jumpserver",function(e){var n;if("undefined"!=typeof e.kiwi_server&&(n=e.kiwi_server,"/"===n[n.length-1]&&(n=n.substring(0,n.length-1)),h.app.kiwi_server=n,e.force)){var i=60*Math.random()+300,s=h.global.i18n.translate("client_models_application_jumpserver_prepare").fetch();t.message.text(s,{timeout:1e4}),setTimeout(function(){var e=h.global.i18n.translate("client_models_application_jumpserver_reconnect").fetch();t.message.text(e,{timeout:8e3}),setTimeout(function(){h.gateway.reconnect(function(){t.connections.forEach(function(e){e.reconnect()})})},5e3)},1e3*i)}})},this.bindControllboxCommands=function(e){$.extend(e.preprocessor.aliases,{"/p":"/part $1+","/me":"/action $1+","/j":"/join $1+","/q":"/query $1+","/w":"/whois $1+","/raw":"/quote $1+","/op":"/quote mode $channel +o $1+","/deop":"/quote mode $channel -o $1+","/hop":"/quote mode $channel +h $1+","/dehop":"/quote mode $channel -h $1+","/voice":"/quote mode $channel +v $1+","/devoice":"/quote mode $channel -v $1+","/k":"/kick $channel $1+","/slap":"/me slaps $1 around a bit with a large trout"}),e.on("unknown_command",n),e.on("command",i),e.on("command:msg",c),e.on("command:action",l),e.on("command:join",s),e.on("command:part",r),e.on("command:nick",function(e){h.gateway.changeNick(null,e.params[0])}),e.on("command:query",o),e.on("command:invite",b),e.on("command:topic",p),e.on("command:notice",d),e.on("command:quote",g),e.on("command:kick",u),e.on("command:clear",m),e.on("command:ctcp",f),e.on("command:server",M),e.on("command:whois",y),e.on("command:whowas",C),e.on("command:encoding",x),e.on("command:css",function(){var e="?reload="+(new Date).getTime();$('link[rel="stylesheet"]').each(function(){this.href=this.href.replace(/\?.*|$/,e)})}),e.on("command:js",function(e){e.params[0]&&$script(e.params[0]+"?"+(new Date).getTime())}),e.on("command:set",function(e){if(e.params[0]){var t,n=e.params[0];e.params[1]&&(e.params.shift(),t=e.params.join(" "),"true"===t&&(t=!0),"false"===t&&(t=!1),parseInt(t,10).toString()===t&&(t=parseInt(t,10)),h.global.settings.set(n,t)),h.app.panels().active.addMsg("",n+" = "+h.global.settings.get(n).toString())}}),e.on("command:save",function(){h.global.settings.save(),h.app.panels().active.addMsg("",h.global.i18n.translate("client_models_application_settings_saved").fetch())}),e.on("command:alias",function(t){var n,i;return t.params[1]?"del"===t.params[0]||"delete"===t.params[0]?(n=t.params[1],"/"!==n[0]&&(n="/"+n),delete e.preprocessor.aliases[n],void 0):(n=t.params[0],t.params.shift(),i=t.params.join(" "),"/"!==n[0]&&(n="/"+n),e.preprocessor.aliases[n]=i,void 0):($.each(e.preprocessor.aliases,function(e,t){h.app.panels().server.addMsg(" ",e+"   =>   "+t)}),void 0)}),e.on("command:ignore",function(e){var t=h.gateway.get("ignore_list");return e.params[0]?(t.push(e.params[0]),h.gateway.set("ignore_list",t),h.app.panels().active.addMsg(" ",h.global.i18n.translate("client_models_application_ignore_nick").fetch(e.params[0])),void 0):(t.length>0?(h.app.panels().active.addMsg(" ",h.global.i18n.translate("client_models_application_ignore_title").fetch()+":"),$.each(t,function(e,t){h.app.panels().active.addMsg(" ",t)})):h.app.panels().active.addMsg(" ",h.global.i18n.translate("client_models_application_ignore_none").fetch()),void 0)}),e.on("command:unignore",function(e){var t=h.gateway.get("ignore_list");return e.params[0]?(t=_.reject(t,function(t){return t===e.params[0]}),h.gateway.set("ignore_list",t),h.app.panels().active.addMsg(" ",h.global.i18n.translate("client_models_application_ignore_stopped").fetch(e.params[0])),void 0):(h.app.panels().active.addMsg(" ",h.global.i18n.translate("client_models_application_ignore_stop_notice").fetch()),void 0)}),e.on("command:applet",k),e.on("command:settings",v),e.on("command:script",w)},this.isChannelName=function(e){var t=h.gateway.get("channel_prefix");return e&&e.length?t.indexOf(e[0])>-1:!1}};return n=Backbone.Model.extend(new n),new n(arguments)},h.model.Gateway=function(){var e=null;return this.defaults={name:"Server",address:"",nick:"",channel_prefix:"#",user_prefixes:["~","&","@","+"],kiwi_server:"//kiwi",ignore_list:[]},this.initialize=function(){e=this,this.socket=this.get("socket"),this.applyEventHandlers(),this.disconnect_requested=!1},this.applyEventHandlers=function(){var e=this;this.on("onmsg",function(t){var n,i=h.app.connections.getByConnectionId(t.server),s=t.channel.toLowerCase()==i.get("nick").toLowerCase();n=s?t.nick:t.channel,e.trigger("message:"+n,t),e.trigger("message",t),s&&(e.trigger("pm:"+n,t),e.trigger("pm",t))},this),this.on("onnotice",function(e){var t=e.target||e.nick;this.trigger("notice:"+t,e),this.trigger("notice",e)},this),this.on("onaction",function(t){var n,i=h.app.connections.getByConnectionId(t.server),s=t.channel.toLowerCase()==i.get("nick").toLowerCase();n=s?t.nick:t.channel,e.trigger("action:"+n,t),s&&(e.trigger("action:"+n,t),e.trigger("action",t))},this),this.on("ontopic",function(t){e.trigger("topic:"+t.channel,t),e.trigger("topic",t)}),this.on("onjoin",function(t){e.trigger("join:"+t.channel,t),e.trigger("join",t)})},this.reconnect=function(e){this.disconnect_requested=!0,this.socket.close(),this.socket=null,this.connect(e)},this.connect=function(t){this.socket=new EngineioTools.ReconnectingSocket(this.get("kiwi_server"),{path:h.app.get("base_path")+"/transport",reconnect_max_attempts:5,reconnect_delay:2e3}),this.rpc=new EngineioTools.Rpc(this.socket),this.socket.on("connect_failed",function(e){this.socket.disconnect(),this.trigger("connect_fail",{reason:e})}),this.socket.on("error",function(t){console.log("_kiwi.gateway.socket.on('error')",{reason:t}),e.trigger("connect_fail",{reason:t})}),this.socket.on("connecting",function(){console.log("_kiwi.gateway.socket.on('connecting')"),e.trigger("connecting")}),this.socket.on("open",function(){e.disconnect_requested=!1,console.log("_kiwi.gateway.socket.on('open')"),t&&t()}),this.rpc.on("too_many_connections",function(){e.trigger("connect_fail",{reason:"too_many_connections"})}),this.rpc.on("irc",function(t,n){e.parse(n.command,n.data)}),this.rpc.on("kiwi",function(t,n){e.parseKiwi(n.command,n.data)}),this.socket.on("close",function(){e.trigger("disconnect",{}),console.log("_kiwi.gateway.socket.on('close')")}),this.socket.on("reconnecting",function(t){console.log("_kiwi.gateway.socket.on('reconnecting')"),e.trigger("reconnecting",{delay:t.delay,attempts:t.attempts})}),this.socket.on("reconnecting_failed",function(){console.log("_kiwi.gateway.socket.on('reconnect_failed')")})},this.newConnection=function(e,t){this.makeIrcConnection(e,function(n,i){var s;if(n)console.log("_kiwi.gateway.socket.on('error')",{reason:n}),t&&t(n);else{if(!h.app.connections.getByConnectionId(i)){var a={connection_id:i,nick:e.nick,address:e.host,port:e.port,ssl:e.ssl,password:e.password};s=new h.model.Network(a),h.app.connections.add(s)}console.log("_kiwi.gateway.socket.on('connect')",s),t&&t(n,s)}})},this.makeIrcConnection=function(e,t){var n={command:"connect",nick:e.nick,hostname:e.host,port:e.port,ssl:e.ssl,password:e.password};e.options=e.options||{},e.options.encoding&&(n.encoding=e.options.encoding),this.rpc.call("kiwi",n,function(e,n){e?t&&t(e):t&&t(e,n)})},this.isConnected=function(){return this.socket},this.parseKiwi=function(e,t){this.trigger("kiwi:"+e,t),this.trigger("kiwi",t)},this.parse=function(n,i){if(n!==t)switch(n){case"options":$.each(i.options,function(t,n){switch(t){case"CHANTYPES":e.set("channel_prefix",n.join(""));break;case"NETWORK":e.set("name",n);break;case"PREFIX":e.set("user_prefixes",n)}}),e.set("cap",i.cap);break;case"kiwi":this.emit("_kiwi."+i.namespace,i.data)}"undefined"!=typeof i.server&&e.trigger("connection:"+i.server.toString(),{event_name:n,event_data:i}),e.trigger("on"+n,i)},this.sendData=function(e,t,n){("undefined"==typeof e||null===e)&&(e=h.app.connections.active_connection.get("connection_id"));var i={server:e,data:JSON.stringify(t)};this.rpc.call("irc",i,n)},this.privmsg=function(e,t,n,i){var s={method:"privmsg",args:{target:t,msg:n}};this.sendData(e,s,i)},this.notice=function(e,t,n,i){var s={method:"notice",args:{target:t,msg:n}};this.sendData(e,s,i)},this.ctcp=function(e,t,n,i,s,a){var o={method:"ctcp",args:{request:t,type:n,target:i,params:s}};this.sendData(e,o,a)},this.action=function(e,t,n,i){this.ctcp(e,!0,"ACTION",t,n,i)},this.join=function(e,t,n,i){var s={method:"join",args:{channel:t,key:n}};this.sendData(e,s,i)},this.part=function(e,t,n){var i={method:"part",args:{channel:t}};this.sendData(e,i,n)},this.topic=function(e,t,n,i){var s={method:"topic",args:{channel:t,topic:n}};this.sendData(e,s,i)},this.kick=function(e,t,n,i,s){var a={method:"kick",args:{channel:t,nick:n,reason:i}};this.sendData(e,a,s)},this.quit=function(e,t,n){t=t||"";var i={method:"quit",args:{message:t}};this.sendData(e,i,n)},this.raw=function(e,t,n){t={method:"raw",args:{data:t}},this.sendData(e,t,n)},this.changeNick=function(e,t,n){var i={method:"nick",args:{nick:t}};this.sendData(e,i,n)},this.setEncoding=function(e,t,n){var i={method:"encoding",args:{encoding:t}};this.sendData(e,i,n)},this.kiwi=function(e,t,n){t={method:"kiwi",args:{target:e,data:t}},this.sendData(t,n)},this.isNickIgnored=function(e){var t,n,i,s=this.get("ignore_list");for(t=0;t<s.length;t++)if(n=s[t].replace(/([.+^$[\]\\(){}|-])/g,"\\$1").replace("*",".*").replace("?","."),i=new RegExp(n,"i"),i.test(e))return!0;return!1},new(Backbone.Model.extend(this))(arguments)},function(){function e(){$.each(this.panels.models,function(e,t){t.addMsg("",h.global.i18n.translate("client_models_network_disconnected").fetch(),"action quit")})}function i(e){var t;this.set("nick",e.nick),this.rejoinAllChannels(),this.auto_join&&this.auto_join.channel&&(t=this.createAndJoinChannels(this.auto_join.channel+" "+(this.auto_join.key||"")),t&&t[t.length-1].view.show(),delete this.auto_join)}function s(e){var t=this;$.each(e.options,function(e,n){switch(e){case"CHANTYPES":t.set("channel_prefix",n.join(""));break;case"NETWORK":t.set("name",n);break;case"PREFIX":t.set("user_prefixes",n)}}),this.set("cap",e.cap)}function a(e){this.panels.server.addMsg(this.get("name"),e.msg,"motd")}function o(e){var t,n,i;t=this.panels.getByName(e.channel),t||(t=new h.model.Channel({name:e.channel}),this.panels.add(t)),n=t.get("members"),n&&(i=new h.model.Member({nick:e.nick,ident:e.ident,hostname:e.hostname}),n.add(i,{kiwi:e}))}function l(e){var t,n,i,s={};if(s.type="part",s.message=e.message||"",s.time=e.time,t=this.panels.getByName(e.channel)){if(e.nick===this.get("nick"))return t.close(),void 0;n=t.get("members"),n&&(i=n.getByNick(e.nick),i&&n.remove(i,{kiwi:s}))}}function r(e){var t,n={};n.type="quit",n.message=e.message||"",n.time=e.time,$.each(this.panels.models,function(i,s){s.isChannel()&&(t=s.get("members").getByNick(e.nick),t&&s.get("members").remove(t,{kiwi:n}))})}function p(e){var t,n,i,s={};s.type="kick",s.by=e.nick,s.message=e.message||"",s.current_user_kicked=e.kicked==this.get("nick"),s.current_user_initiated=e.nick==this.get("nick"),s.time=e.time,t=this.panels.getByName(e.channel),t&&(n=t.get("members"),n&&(i=n.getByNick(e.kicked),i&&(n.remove(i,{kiwi:s}),s.current_user_kicked&&n.reset([]))))}function d(e){var t,n=e.channel.toLowerCase()==this.get("nick").toLowerCase();h.gateway.isNickIgnored(e.nick)||(n?(t=this.panels.getByName(e.nick),t||(t=new h.model.Query({name:e.nick}),this.panels.add(t))):(t=this.panels.getByName(e.channel),t||(t=this.panels.server)),t.addMsg(e.nick,e.msg,"privmsg",{time:e.time}))}function g(e){var t;$.each(this.panels.models,function(n,i){i.get("name")==e.nick&&i.set("name",e.newnick),i.isChannel()&&(t=i.get("members").getByNick(e.nick),t&&(t.set("nick",e.newnick),i.addMsg("","== "+h.global.i18n.translate("client_models_network_nickname_changed").fetch(e.nick,e.newnick),"action nick",{time:e.time})))})}function u(e){h.gateway.isNickIgnored(e.nick)||"TIME"===e.msg.toUpperCase()&&this.gateway.ctcp(!1,e.type,e.nick,(new Date).toString())}function m(e){h.gateway.isNickIgnored(e.nick)||this.panels.server.addMsg("["+e.nick+"]","CTCP "+e.msg,"ctcp",{time:e.time})}function f(e){var t,n;!e.from_server&&e.nick&&h.gateway.isNickIgnored(e.nick)||(e.from_server?t=this.panels.server:(t=this.panels.getByName(e.target)||this.panels.getByName(e.nick),e.nick&&"chanserv"==e.nick.toLowerCase()&&"["==e.msg.charAt(0)&&(n=/\[([^ \]]+)\]/gi.exec(e.msg),n&&n[1]&&(n=n[1],t=this.panels.getByName(n))),t||(t=this.panels.server)),t.addMsg("["+(e.nick||"")+"]",e.msg,"notice",{time:e.time}),e.from_server||t!==this.panels.server||h.app.panels().active===this.panels.server||h.app.panels().active.addMsg("["+(e.nick||"")+"]",e.msg,"notice",{time:e.time}))}function v(e){var t,n=e.channel.toLowerCase()==this.get("nick").toLowerCase();h.gateway.isNickIgnored(e.nick)||(n?(t=this.panels.getByName(e.nick),t||(t=new h.model.Channel({name:e.nick}),this.panels.add(t))):(t=this.panels.getByName(e.channel),t||(t=this.panels.server)),t.addMsg("","* "+e.nick+" "+e.msg,"action",{time:e.time}))}function w(e){var t;t=this.panels.getByName(e.channel),t&&(t.set("topic",e.topic),t.get("name")===this.panels.active.get("name")&&h.app.topicbar.setCurrentTopic(e.topic))}function k(e){var t,n;t=this.panels.getByName(e.channel),t&&(n=c(new Date(1e3*e.when)),t.addMsg("",h.global.i18n.translate("client_models_network_topic").fetch(e.nick,n),"topic"))}function b(e){var t;t=this.panels.getByName(e.channel),t&&(t.temp_userlist=t.temp_userlist||[],_.each(e.users,function(e){var n=new h.model.Member({nick:e.nick,modes:e.modes});t.temp_userlist.push(n)}))}function y(e){var t;t=this.panels.getByName(e.channel),t&&(t.get("members").reset(t.temp_userlist||[]),delete t.temp_userlist)}function C(e){function t(t,n){var i,s={};return t||(t=e.modes,n=e.target),_.each(t,function(e){var t=e.param||n||"";s[t]||(s[t]={"+":"","-":""}),s[t][e.mode[0]]+=e.mode.substr(1)}),i=[],_.each(s,function(e,t){var n="";e["+"]&&(n+="+"+e["+"]),e["-"]&&(n+="-"+e["-"]),i.push(n+" "+t)}),i=i.join(", ")}var n,i,s,a,o,c;if(n=this.panels.getByName(e.target)){for(s=this.get("user_prefixes"),c=function(t){return e.modes[i].mode[1]===t.mode},i=0;i<e.modes.length;i++)if(_.any(s,c)){if(a||(a=n.get("members")),o=a.getByNick(e.modes[i].param),!o)return console.log("MODE command recieved for unknown member %s on channel %s",e.modes[i].param,e.target),void 0;"+"===e.modes[i].mode[0]?o.addMode(e.modes[i].mode[1]):"-"===e.modes[i].mode[0]&&o.removeMode(e.modes[i].mode[1]),a.sort()}n.addMsg("","== "+h.global.i18n.translate("client_models_network_mode").fetch(e.nick,t()),"action mode",{time:e.time})}else e.target.toLowerCase()===this.get("nick").toLowerCase()?this.panels.server.addMsg("","== "+h.global.i18n.translate("client_models_network_selfmode").fetch(e.nick,t()),"action mode"):console.log("MODE command recieved for unknown target %s: ",e.target,e)
}function x(e){var t,i,s="";e.end||("undefined"!=typeof e.idle&&(s=n(parseInt(e.idle,10)),s=s.h.toString().lpad(2,"0")+":"+s.m.toString().lpad(2,"0")+":"+s.s.toString().lpad(2,"0")),i=h.app.panels().active,e.ident?i.addMsg(e.nick,e.nick+" ["+e.nick+"!"+e.ident+"@"+e.host+"] * "+e.msg,"whois"):e.chans?i.addMsg(e.nick,h.global.i18n.translate("client_models_network_channels").fetch(e.chans),"whois"):e.irc_server?i.addMsg(e.nick,h.global.i18n.translate("client_models_network_server").fetch(e.irc_server,e.server_info),"whois"):e.msg?i.addMsg(e.nick,e.msg,"whois"):e.logon?(t=new Date,t.setTime(1e3*e.logon),t=c(t),i.addMsg(e.nick,h.global.i18n.translate("client_models_network_idle_and_signon").fetch(s,t),"whois")):e.away_reason?i.addMsg(e.nick,h.global.i18n.translate("client_models_network_away").fetch(e.away_reason),"whois"):i.addMsg(e.nick,h.global.i18n.translate("client_models_network_idle").fetch(s),"whois"))}function M(e){var t;e.end||(t=h.app.panels().active,e.host?t.addMsg(e.nick,e.nick+" ["+e.nick+(e.ident?"!"+e.ident:"")+"@"+e.host+"] * "+e.real_name,"whois"):t.addMsg(e.nick,h.global.i18n.translate("client_models_network_nickname_notfound").fetch(),"whois"))}function S(e){$.each(this.panels.models,function(t,n){n.isChannel()&&(member=n.get("members").getByNick(e.nick),member&&member.set("away",!!e.trailing))})}function N(){var e=h.model.Applet.loadOnce("kiwi_chanlist");e.view.show()}function T(e){var n,i;switch(e.channel===t||(n=this.panels.getByName(e.channel))||(n=this.panels.server),e.error){case"banned_from_channel":n.addMsg(" ","== "+h.global.i18n.translate("client_models_network_banned").fetch(e.channel,e.reason),"status"),h.app.message.text(h.global.i18n.translate("client_models_network_banned").fetch(e.channel,e.reason));break;case"bad_channel_key":n.addMsg(" ","== "+h.global.i18n.translate("client_models_network_channel_badkey").fetch(e.channel),"status"),h.app.message.text(h.global.i18n.translate("client_models_network_channel_badkey").fetch(e.channel));break;case"invite_only_channel":n.addMsg(" ","== "+h.global.i18n.translate("client_models_network_channel_inviteonly").fetch(e.channel),"status"),h.app.message.text(h.global.i18n.translate("client_models_network_channel_inviteonly").fetch(e.channel));break;case"user_on_channel":n.addMsg(" ","== "+e.nick+" is already on this channel");break;case"channel_is_full":n.addMsg(" ","== "+h.global.i18n.translate("client_models_network_channel_limitreached").fetch(e.channel),"status"),h.app.message.text(h.global.i18n.translate("client_models_network_channel_limitreached").fetch(e.channel));break;case"chanop_privs_needed":n.addMsg(" ","== "+e.reason,"status"),h.app.message.text(e.reason+" ("+e.channel+")");break;case"no_such_nick":i=this.panels.getByName(e.nick),i?i.addMsg(" ","== "+e.nick+": "+e.reason,"status"):this.panels.server.addMsg(" ","== "+e.nick+": "+e.reason,"status");break;case"nickname_in_use":this.panels.server.addMsg(" ","== "+h.global.i18n.translate("client_models_network_nickname_alreadyinuse").fetch(e.nick),"status"),this.panels.server!==this.panels.active&&h.app.message.text(h.global.i18n.translate("client_models_network_nickname_alreadyinuse").fetch(e.nick)),"none"!==h.app.controlbox.$el.css("display")&&(new h.view.NickChangeBox).render();break;case"password_mismatch":this.panels.server.addMsg(" ","== "+h.global.i18n.translate("client_models_network_badpassword").fetch(),"status")}}function B(e){var t=_.clone(e.params);t[0]&&t[0]==this.get("nick")&&t.shift(),e.trailing&&t.push(e.trailing),this.panels.server.addMsg("","["+e.command+"] "+t.join(", ",""))}h.model.Network=Backbone.Model.extend({defaults:{connection_id:0,name:"Network",address:"",port:6667,ssl:!1,password:"",nick:"",channel_prefix:"#",user_prefixes:["~","&","@","+"]},initialize:function(){"undefined"!=typeof this.get("connection_id")&&(this.gateway=h.global.components.Network(this.get("connection_id")),this.bindGatewayEvents()),this.panels=new h.model.PanelList([],this);var e=new h.model.Server({name:"Server"});this.panels.add(e),this.panels.server=this.panels.active=e},reconnect:function(e){var t=this,n={nick:this.get("nick"),host:this.get("address"),port:this.get("port"),ssl:this.get("ssl"),password:this.get("password")};h.gateway.makeIrcConnection(n,function(n,i){n?(console.log("_kiwi.gateway.socket.on('error')",{reason:n}),e&&e(n)):(t.gateway.dispose(),t.set("connection_id",i),t.gateway=h.global.components.Network(t.get("connection_id")),t.bindGatewayEvents(),e&&e(n))})},bindGatewayEvents:function(){this.gateway.on("connect",i,this),this.gateway.on("disconnect",e,this),this.gateway.on("nick",function(e){e.nick===this.get("nick")&&this.set("nick",e.newnick)},this),this.gateway.on("options",s,this),this.gateway.on("motd",a,this),this.gateway.on("join",o,this),this.gateway.on("part",l,this),this.gateway.on("quit",r,this),this.gateway.on("kick",p,this),this.gateway.on("msg",d,this),this.gateway.on("nick",g,this),this.gateway.on("ctcp_request",u,this),this.gateway.on("ctcp_response",m,this),this.gateway.on("notice",f,this),this.gateway.on("action",v,this),this.gateway.on("topic",w,this),this.gateway.on("topicsetby",k,this),this.gateway.on("userlist",b,this),this.gateway.on("userlist_end",y,this),this.gateway.on("mode",C,this),this.gateway.on("whois",x,this),this.gateway.on("whowas",M,this),this.gateway.on("away",S,this),this.gateway.on("list_start",N,this),this.gateway.on("irc_error",T,this),this.gateway.on("unknown_command",B,this)},createAndJoinChannels:function(e){var t=this,n=[];return"string"==typeof e&&(e=e.split(",")),$.each(e,function(e,i){var s=i.trim().split(" "),a=s[0],o=s[1]||"";return a=a.trim(),h.app.isChannelName(a)?(channel=t.panels.getByName(a),channel||(channel=new h.model.Channel({name:a}),t.panels.add(channel)),n.push(channel),t.gateway.join(a,o),void 0):(t.panels.server.addMsg("",h.global.i18n.translate("client_models_network_channel_invalid_name").fetch(a)),h.app.message.text(h.global.i18n.translate("client_models_network_channel_invalid_name").fetch(a),{timeout:5e3}),void 0)}),n},rejoinAllChannels:function(){var e=this;this.panels.forEach(function(t){t.isChannel()&&e.gateway.join(t.get("name"))})}})}(),h.model.Member=Backbone.Model.extend({sortModes:function(e){return e.sort(function(e,t){var n,i,s,a=h.gateway.get("user_prefixes");for(s=0;s<a.length;s++)a[s].mode===e&&(n=s);for(s=0;s<a.length;s++)a[s].mode===t&&(i=s);return i>n?-1:n>i?1:0})},initialize:function(){var e,t;e=this.stripPrefix(this.get("nick")),t=this.get("modes"),t=t||[],this.sortModes(t),this.set({nick:e,modes:t,prefix:this.getPrefix(t)},{silent:!0}),this.isOp(),this.view=new h.view.Member({model:this})},addMode:function(e){var t,n=e.split("");t=this.get("modes"),$.each(n,function(e,n){t.push(n)}),t=this.sortModes(t),this.set({prefix:this.getPrefix(t),modes:t}),this.isOp(),this.view.render()},removeMode:function(e){var t,n=e.split("");t=this.get("modes"),t=_.reject(t,function(e){return-1!==_.indexOf(n,e)}),this.set({prefix:this.getPrefix(t),modes:t}),this.isOp(),this.view.render()},getPrefix:function(e){var t="",n=h.gateway.get("user_prefixes");return"undefined"!=typeof e[0]&&(t=_.detect(n,function(t){return t.mode===e[0]}),t=t?t.symbol:""),t},stripPrefix:function(e){var t,n,i,s,a=e,o=h.gateway.get("user_prefixes");t=0;e:for(n=0;n<e.length;n++){for(s=e.charAt(n),i=0;i<o.length;i++)if(s===o[i].symbol){t++;continue e}break}return a.substr(t)},displayNick:function(e){var t=this.get("nick");return e&&this.get("ident")&&(t+=" ["+this.get("ident")+"@"+this.get("hostname")+"]"),t},isOp:function(){var e,t,n=h.gateway.get("user_prefixes"),i=this.get("modes");i.length>0?(e=_.indexOf(n,_.find(n,function(e){return"o"===e.mode})),t=_.indexOf(n,_.find(n,function(e){return e.mode===i[0]})),-1===t||t>e?this.set({is_op:!1},{silent:!0}):this.set({is_op:!0},{silent:!0})):this.set({is_op:!1},{silent:!0})}}),h.model.MemberList=Backbone.Collection.extend({model:h.model.Member,comparator:function(e,t){var n,i,s,a,o,c,l,r=h.gateway.get("user_prefixes");if(i=e.get("modes"),s=t.get("modes"),i.length>0){if(0===s.length)return-1;for(a=o=-1,n=0;n<r.length;n++)r[n].mode===i[0]&&(a=n);for(n=0;n<r.length;n++)r[n].mode===s[0]&&(o=n);if(o>a)return-1;if(a>o)return 1}else if(s.length>0)return 1;return c=e.get("nick").toLocaleUpperCase(),l=t.get("nick").toLocaleUpperCase(),l>c?-1:c>l?1:0},initialize:function(){this.view=new h.view.MemberList({model:this})},getByNick:function(e){return"string"==typeof e?this.find(function(t){return e.toLowerCase()===t.get("nick").toLowerCase()}):void 0}}),h.model.NewConnection=Backbone.Collection.extend({initialize:function(){this.view=new h.view.ServerSelect,this.view.bind("server_connect",this.onMakeConnection,this)},onMakeConnection:function(e){var t=this;this.view.networkConnecting(),h.gateway.set("kiwi_server",h.app.kiwi_server),h.gateway.connect(function(){t.makeConnection(e)})},onKiwiServerNotFound:function(){this.view.showError()},makeConnection:function(e){var t=this;this.connect_details=e,h.gateway.newConnection({nick:e.nick,host:e.server,port:e.port,ssl:e.ssl,password:e.password,options:e.options},function(e,n){t.onNewNetwork(e,n)})},onNewNetwork:function(e,t){e&&this.view.showError(e),t&&this.connect_details&&(t.auto_join={channel:this.connect_details.channel,key:this.connect_details.channel_key}),t&&0===t.get("connection_id")&&t.panels.server.view.show()}}),h.model.Panel=Backbone.Model.extend({initialize:function(){var e=this.get("name")||"";this.view=new h.view.Panel({model:this,name:e}),this.set({scrollback:[],name:e},{silent:!0})},closePanel:function(){this.view&&(this.view.unbind(),this.view.remove(),this.view=t,delete this.view);var e=this.get("members");e&&(e.reset([]),this.unset("members")),this.get("panel_list").remove(this),this.unbind(),this.destroy(),this===h.app.panels().active&&h.app.connections.active_connection.panels.server.view.show()},close:function(){return this.closePanel()},isChannel:function(){var e=h.gateway.get("channel_prefix"),t=this.get("name");return this.isApplet()||!t?!1:e.indexOf(t[0])>-1},isQuery:function(){return this.isChannel()||this.isApplet()||this.isServer()?!1:!0},isApplet:function(){return this.applet?!0:!1},isServer:function(){return this.server?!0:!1},isActive:function(){return h.app.panels().active===this}}),h.model.PanelList=Backbone.Collection.extend({model:h.model.Panel,comparator:function(e){return e.get("name")},initialize:function(e,t){t&&(this.network=t),this.view=new h.view.Tabs({model:this}),this.active=null,this.bind("active",function(e){this.active=e},this),this.bind("add",function(e){e.set("panel_list",this)})},getByCid:function(e){return"string"==typeof name?this.find(function(t){return e===t.cid}):void 0},getByName:function(e){return"string"==typeof e?this.find(function(t){return e.toLowerCase()===t.get("name").toLowerCase()}):void 0}}),h.model.NetworkPanelList=Backbone.Collection.extend({model:h.model.Network,initialize:function(){this.view=new h.view.NetworkTabs({model:this}),this.on("add",this.onNetworkAdd,this),this.on("remove",this.onNetworkRemove,this),this.active_connection=t,this.active_panel=t,this.active=t},getByConnectionId:function(e){return this.find(function(t){return t.get("connection_id")==e})},panels:function(){var e=[];return this.each(function(t){e=e.concat(t.panels.models)}),e},onNetworkAdd:function(e){e.panels.on("active",this.onPanelActive,this),1===this.models.length&&(this.active_connection=e,this.active_panel=e.panels.server,this.active=this.active_panel)},onNetworkRemove:function(e){e.panels.off("active",this.onPanelActive,this)},onPanelActive:function(e){var t=this.getByConnectionId(e.tab.data("connection_id"));this.trigger("active",e,t),this.active_connection=t,this.active_panel=e,this.active=e}}),h.model.Channel=h.model.Panel.extend({initialize:function(){var e,t=this.get("name")||"";this.set({members:new h.model.MemberList,name:t,scrollback:[],topic:""},{silent:!0}),this.view=new h.view.Channel({model:this,name:t}),e=this.get("members"),e.channel=this,e.bind("add",function(e,t,n){var i=h.global.settings.get("show_joins_parts");i!==!1&&this.addMsg(" ","== "+h.global.i18n.translate("client_models_channel_join").fetch(e.displayNick(!0)),"action join",{time:n.kiwi.time})},this),e.bind("remove",function(e,t,n){var i=h.global.settings.get("show_joins_parts"),s=n.kiwi.message?"("+n.kiwi.message+")":"";"quit"===n.kiwi.type&&i?this.addMsg(" ","== "+h.global.i18n.translate("client_models_channel_quit").fetch(e.displayNick(!0),s),"action quit",{time:n.kiwi.time}):"kick"===n.kiwi.type?n.kiwi.current_user_kicked?this.addMsg(" ","== "+h.global.i18n.translate("client_models_channel_selfkick").fetch(n.kiwi.by,s),"action kick",{time:n.kiwi.time}):(i||n.kiwi.current_user_initiated)&&this.addMsg(" ","== "+h.global.i18n.translate("client_models_channel_kicked").fetch(e.displayNick(!0),n.kiwi.by,s),"action kick",{time:n.kiwi.time}):i&&this.addMsg(" ","== "+h.global.i18n.translate("client_models_channel_part").fetch(e.displayNick(!0),s),"action part",{time:n.kiwi.time})},this)},addMsg:function(e,t,n,i){var s,a,o=parseInt(h.global.settings.get("scrollback"),10)||250;i=i||{},i.time="number"==typeof i.time?new Date(i.time):new Date,i&&"undefined"!=typeof i.style||(i.style=""),s={msg:t,date:i.date,time:i.time,nick:e,chan:this.get("name"),type:n,style:i.style},s&&("string"!=typeof s.type&&(s.type=""),"string"!=typeof s.msg&&(s.msg=""),a=this.get("scrollback"),a&&(a.push(s),a.length>o&&a.splice(o),this.set({scrollback:a},{silent:!0})),this.trigger("msg",s))},clearMessages:function(){this.set({scrollback:[]},{silent:!0}),this.addMsg("","Window cleared"),this.view.render()}}),h.model.Query=h.model.Channel.extend({initialize:function(){var e=this.get("name")||"";this.view=new h.view.Channel({model:this,name:e}),this.set({name:e,scrollback:[]},{silent:!0})}}),h.model.Server=h.model.Channel.extend({server:!0,initialize:function(){var e="Server";this.view=new h.view.Channel({model:this,name:e}),this.set({scrollback:[],name:e},{silent:!0})}}),h.model.Applet=h.model.Panel.extend({applet:!0,initialize:function(){var e="applet_"+(new Date).getTime().toString()+Math.ceil(100*Math.random()).toString();this.view=new h.view.Applet({model:this,name:e}),this.set({name:e},{silent:!0}),this.loaded_applet=null},load:function(e,t){return"object"==typeof e?(e.get||e.extend)&&(this.set("title",e.get("title")||h.global.i18n.translate("client_models_applet_unknown").fetch()),e.bind("change:title",function(e,t){this.set("title",t)},this),this.view.$el.html(""),e.view&&this.view.$el.append(e.view.$el),this.loaded_applet=e,this.loaded_applet.trigger("applet_loaded")):"string"==typeof e&&this.loadFromUrl(e,t),this},loadFromUrl:function(e,t){var n=this;this.view.$el.html(h.global.i18n.translate("client_models_applet_loading").fetch()),$script(e,function(){return h.applets[t]?(n.load(new h.applets[t]),void 0):(n.view.$el.html(h.global.i18n.translate("client_models_applet_notfound").fetch()),void 0)})},close:function(){this.view.$el.remove(),this.destroy(),this.view=t,this.loaded_applet&&this.loaded_applet.dispose&&this.loaded_applet.dispose(),this.closePanel()}},{loadOnce:function(e){var t=_.find(h.app.panels("applets"),function(t){return t.isApplet()&&t.loaded_applet?t.loaded_applet.get("_applet_name")===e?!0:void 0:void 0});return t?t:this.load(e)},load:function(e){var t;if(h.applets[e])return t=new h.model.Applet,t.load(new h.applets[e]({_applet_name:e})),h.app.applet_panels.add(t),t},register:function(e,t){h.applets[e]=t}}),h.model.PluginManager=Backbone.Model.extend({initialize:function(){this.$plugin_holder=$('<div id="kiwi_plugins" style="display:none;"></div>').appendTo(h.app.view.$el),this.loaded_plugins={}},load:function(e){this.loaded_plugins[e]&&this.unload(e),this.loaded_plugins[e]=$("<div></div>"),this.loaded_plugins[e].appendTo(this.$plugin_holder).load(e)},unload:function(e){this.loaded_plugins[e]&&(this.loaded_plugins[e].remove(),delete this.loaded_plugins[e])}}),h.model.DataStore=Backbone.Model.extend({initialize:function(){this._namespace="",this.new_data={}},namespace:function(e){return e&&(this._namespace=e),this._namespace},save:function(){localStorage.setItem(this._namespace,JSON.stringify(this.attributes))},load:function(){if(localStorage){var e;try{e=JSON.parse(localStorage.getItem(this._namespace))||{}}catch(t){e={}}this.attributes=e}}},{instance:function(e,t){var n=new h.model.DataStore(t);return n.namespace(e),n}}),function(){var e=Backbone.View.extend({events:{"change [data-setting]":"saveSettings",'click [data-setting="theme"]':"selectTheme","click .register_protocol":"registerProtocol","click .enable_notifications":"enableNoticiations"},initialize:function(){var e={tabs:h.global.i18n.translate("client_applets_settings_channelview_tabs").fetch(),list:h.global.i18n.translate("client_applets_settings_channelview_list").fetch(),large_amounts_of_chans:h.global.i18n.translate("client_applets_settings_channelview_list_notice").fetch(),join_part:h.global.i18n.translate("client_applets_settings_notification_joinpart").fetch(),timestamps:h.global.i18n.translate("client_applets_settings_timestamp").fetch(),mute:h.global.i18n.translate("client_applets_settings_notification_sound").fetch(),emoticons:h.global.i18n.translate("client_applets_settings_emoticons").fetch(),scroll_history:h.global.i18n.translate("client_applets_settings_history_length").fetch(),languages:h.app.translations,default_client:h.global.i18n.translate("client_applets_settings_default_client").fetch(),make_default:h.global.i18n.translate("client_applets_settings_default_client_enable").fetch(),locale_restart_needed:h.global.i18n.translate("client_applets_settings_locale_restart_needed").fetch(),default_note:h.global.i18n.translate("client_applets_settings_default_client_notice").fetch('<a href="chrome://settings/handlers">chrome://settings/handlers</a>'),html5_notifications:h.global.i18n.translate("client_applets_settings_html5_notifications").fetch(),enable_notifications:h.global.i18n.translate("client_applets_settings_enable_notifications").fetch()};this.$el=$(_.template($("#tmpl_applet_settings").html().trim(),e)),navigator.registerProtocolHandler||this.$el.find(".protocol_handler").remove(),window.webkitNotifications||this.$el.find("notification_enabler").remove(),h.global.settings.on("change",this.loadSettings,this),this.loadSettings()},loadSettings:function(){var e=this;$.each(h.global.settings.attributes,function(t,n){var i=$('[data-setting="'+t+'"]',e.$el);if(i.length)switch(i.prop("type")){case"checkbox":i.prop("checked",n);break;case"radio":$('[data-setting="'+t+'"][value="'+n+'"]',e.$el).prop("checked",!0);break;case"text":i.val(n);break;case"select-one":$('[value="'+n+'"]',e.$el).prop("selected",!0);break;default:$('[data-setting="'+t+'"][data-value="'+n+'"]',e.$el).addClass("active")}})},saveSettings:function(e){var t,n=h.global.settings,i=$(e.currentTarget,this.$el);switch(e.currentTarget.type){case"checkbox":t=i.is(":checked");break;case"radio":case"text":t=i.val();break;case"select-one":t=$(e.currentTarget[i.prop("selectedIndex")]).val();break;default:t=i.data("value")}h.global.settings.off("change",this.loadSettings,this),n.set(i.data("setting"),t),n.save(),h.global.settings.on("change",this.loadSettings,this)},selectTheme:function(e){$('[data-setting="theme"].active',this.$el).removeClass("active"),$(e.currentTarget).addClass("active").trigger("change"),e.preventDefault()},registerProtocol:function(){navigator.registerProtocolHandler("irc",document.location.origin+h.app.get("base_path")+"/%s","Kiwi IRC"),navigator.registerProtocolHandler("ircs",document.location.origin+h.app.get("base_path")+"/%s","Kiwi IRC")},enableNoticiations:function(){window.webkitNotifications.requestPermission()}}),t=Backbone.Model.extend({initialize:function(){this.set("title",h.global.i18n.translate("client_applets_settings_title").fetch()),this.view=new e}});h.model.Applet.register("kiwi_settings",t)}(),function(){var e=Backbone.View.extend({events:{"click .chan":"chanClick"},initialize:function(){var e={channel_name:h.global.i18n.translate("client_applets_chanlist_channelname").fetch(),users:h.global.i18n.translate("client_applets_chanlist_users").fetch(),topic:h.global.i18n.translate("client_applets_chanlist_topic").fetch()};this.$el=$(_.template($("#tmpl_channel_list").html().trim(),e)),this.channels=[],this.ordered=!0,this.waiting=!1},render:function(){var e,t=$("table",this.$el),n=t.children("tbody:first").detach(),i=this,s=this.channels.length;for(n.children().each(function(e,t){i.channels[e].channel===$(t.querySelector(".chan")).data("channel")&&(i.channels[e].dom=n[0].removeChild(t))}),this.ordered&&this.channels.sort(function(e,t){return t.num_users-e.num_users}),e=0;s>e;e++)n[0].appendChild(this.channels[e].dom);t[0].appendChild(n[0])},chanClick:function(e){e.target?h.gateway.join(null,$(e.target).data("channel")):h.gateway.join(null,$(e.srcElement).data("channel"))}}),t=Backbone.Model.extend({initialize:function(){this.set("title",h.global.i18n.translate("client_applets_chanlist_channellist").fetch()),this.view=new e,this.network=h.global.components.Network(),this.network.on("onlist_channel",this.onListChannel,this),this.network.on("onlist_start",this.onListStart,this)},onListChannel:function(e){this.addChannel(e.chans)},onListStart:function(){},addChannel:function(e){var t=this;_.isArray(e)||(e=[e]),_.each(e,function(e){var n;n=document.createElement("tr"),n.innerHTML='<td><a class="chan" data-channel="'+e.channel+'">'+_.escape(e.channel)+'</a></td><td class="num_users" style="text-align: center;">'+e.num_users+'</td><td style="padding-left: 2em;">'+o(_.escape(e.topic))+"</td>",e.dom=n,t.view.channels.push(e)}),t.view.waiting||(t.view.waiting=!0,_.defer(function(){t.view.render(),t.view.waiting=!1}))},dispose:function(){this.view.channels=null,this.view.unbind(),this.view.$el.html(""),this.view.remove(),this.view=null,this.network.off()}});h.model.Applet.register("kiwi_chanlist",t)}(),function(){var e=Backbone.View.extend({events:{"click .btn_save":"onSave"},initialize:function(){var e=this,t={save:h.global.i18n.translate("client_applets_scripteditor_save").fetch()};this.$el=$(_.template($("#tmpl_script_editor").html().trim(),t)),this.model.on("applet_loaded",function(){e.$el.parent().css("height","100%"),$script(h.app.get("base_path")+"/assets/libs/ace/ace.js",function(){e.createAce()})})},createAce:function(){var e="editor_"+Math.floor(1e7*Math.random()).toString();this.editor_id=e,this.$el.find(".editor").attr("id",e),this.editor=ace.edit(e),this.editor.setTheme("ace/theme/monokai"),this.editor.getSession().setMode("ace/mode/javascript");var t=h.global.settings.get("user_script")||"";this.editor.setValue(t)},onSave:function(){var e,t;e="var network = kiwi.components.Network();\n",e+="var input = kiwi.components.ControlInput();\n",e+=this.editor.getValue()+"\n",e+="this._dispose = function(){ network.off(); if(this.dispose) this.dispose(); }";try{t=new Function(e),h.user_script&&h.user_script._dispose&&h.user_script._dispose(),h.user_script=new t}catch(n){return this.setStatus(h.global.i18n.translate("client_applets_scripteditor_error").fetch(n.toString())),void 0}h.global.settings.set("user_script",this.editor.getValue()),h.global.settings.save(),this.setStatus(h.global.i18n.translate("client_applets_scripteditor_saved").fetch()+" :)")},setStatus:function(e){var t=this.$el.find(".toolbar .status");e=e||"",t.slideUp("fast",function(){t.text(e),t.slideDown()})}}),t=Backbone.Model.extend({initialize:function(){this.set("title",h.global.i18n.translate("client_applets_scripteditor_title").fetch()),this.view=new e({model:this})}});h.model.Applet.register("kiwi_script_editor",t)}(),"undefined"==typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),"undefined"==typeof String.prototype.lpad&&(String.prototype.lpad=function(e,t){var n,i="";for(n=0;e>n;n++)i+=t;return(i+this).slice(-e)}),h.view.Panel=Backbone.View.extend({tagName:"div",className:"panel",events:{},initialize:function(e){this.initializePanel(e)},initializePanel:function(e){this.$el.css("display","none"),e=e||{},this.$container=e.container?$(e.container):$("#kiwi .panels .container1"),this.$el.appendTo(this.$container),this.alert_level=0,this.model.set({view:this},{silent:!0})},render:function(){},show:function(){var e=this.$el;this.$container.children(".panel").css("display","none"),e.css("display","block");var t=this.model.get("members");t?($("#kiwi .memberlists").removeClass("disabled"),t.view.show()):$("#kiwi .memberlists").addClass("disabled").children().removeClass("active"),this.alert("none"),this.model.tab.find(".activity").text("0").addClass("zero"),h.app.panels.trigger("active",this.model,h.app.panels().active),this.model.trigger("active",this.model),h.app.view.doLayout(),this.scrollToBottom(!0)},alert:function(e){if(this.model!=h.app.panels().active){var t,n;t=["none","action","activity","highlight"],e=e||"none",n=_.indexOf(t,e),n||(e="none",n=0),0!==n&&n<=this.alert_level||(this.model.tab.removeClass(function(e,t){return(t.match(/\balert_\S+/g)||[]).join(" ")}),"none"!==e&&this.model.tab.addClass("alert_"+e),this.alert_level=n)}},scrollToBottom:function(e){this.model===h.app.panels().active&&(e||this.$container.scrollTop()+this.$container.height()>this.$el.outerHeight()-150)&&(this.$container[0].scrollTop=this.$container[0].scrollHeight)}}),h.view.Channel=h.view.Panel.extend({events:function(){var e=this.constructor.__super__.events;return _.isFunction(e)&&(e=e()),_.extend({},e,{"click .msg .nick":"nickClick","click .chan":"chanClick","click .media .open":"mediaClick","mouseenter .msg .nick":"msgEnter","mouseleave .msg .nick":"msgLeave"})},initialize:function(e){this.initializePanel(e),this.$messages=$('<div class="messages"></div>'),this.$el.append(this.$messages),this.model.bind("change:topic",this.topic,this),this.model.get("members")&&this.model.get("members").bind("add",function(e){e.get("nick")===this.model.collection.network.get("nick")&&this.$el.find(".initial_loader").slideUp(function(){$(this).remove()})},this),this.model.isChannel()&&this.$el.append('<div class="initial_loader" style="margin:1em;text-align:center;"> '+h.global.i18n.translate("client_views_channel_joining").fetch()+' <span class="loader"></span></div>'),this.model.bind("msg",this.newMsg,this),this.msg_count=0},render:function(){var e=this;this.$messages.empty(),_.each(this.model.get("scrollback"),function(t){e.newMsg(t)})},newMsg:function(e){var t,n,i,a,c,p,d="",g=this.model.get("scrollback"),u=g[g.length-2];new RegExp("(^|\\W)("+l(h.app.connections.active_connection.get("nick"))+")(\\W|$)","i").test(e.msg)&&(c=!0,d+=" highlight"),e.msg=$("<div />").text(e.msg).html(),t=new RegExp("(?:^|\\s)(["+l(h.gateway.get("channel_prefix"))+"][^ ,\\007]+)","g"),e.msg=e.msg.replace(t,function(e){return'<a class="chan" data-channel="'+e.trim()+'">'+e+"</a>"}),e.msg=e.msg.replace(/(([A-Za-z][A-Za-z0-9\-]*\:\/\/)|(www\.))([\w.\-]+)([a-zA-Z]{2,6})(:[0-9]+)?(\/[\w#!:.?$'()[\]*,;~+=&%@!\-\/]*)?/gi,function(e){var t=e,n="";return e.match(/^www\./)&&(e="http://"+e),t.length>100&&(t=t.substr(0,100)+"..."),n=h.view.MediaMessage.buildHtml(e),'<a class="link_ext" target="_blank" rel="nofollow" href="'+e+'">'+t+"</a>"+n}),e.msg=o(e.msg),h.global.settings.get("show_emoticons")&&(e.msg=r(e.msg)),i=function(e){var t,n=0;return _.map(e.split(""),function(e){n+=e.charCodeAt(0)}),t=s(n%255,70,35),t=t[2]|t[1]<<8|t[0]<<16,"#"+t.toString(16)}(e.nick),e.nick_style="color:"+i+";",a=e.nick_css_class="",e.nick&&(_.map(e.nick.split(""),function(e){a+=e.charCodeAt(0).toString(16)}),d+=" nick_"+a),u&&(p=(e.time.getTime()-u.time.getTime())/1e3/60,u.nick===e.nick&&1>p&&(d+=" repeated_nick")),e.msg_css_classes=d,e.time_string=e.time.getHours().toString().lpad(2,"0")+":"+e.time.getMinutes().toString().lpad(2,"0")+":"+e.time.getSeconds().toString().lpad(2,"0"),n='<div class="msg <%= type %> <%= msg_css_classes %>"><div class="time"><%- time_string %></div><div class="nick" style="<%= nick_style %>"><%- nick %></div><div class="text" style="<%= style %>"><%= msg %> </div></div>',this.$messages.append(_.template(n,e)),e.type.match(/^action /)?this.alert("action"):c?(h.app.view.alertWindow("* "+h.global.i18n.translate("client_views_panel_activity").fetch()),h.app.view.favicon.newHighlight(),h.app.view.playSound("highlight"),h.app.view.showNotification(this.model.get("name"),e.msg),this.alert("highlight")):(this.model.isActive()&&h.app.view.alertWindow("* "+h.global.i18n.translate("client_views_panel_activity").fetch()),this.alert("activity")),this.model.isQuery()&&!this.model.isActive()&&(h.app.view.alertWindow("* "+h.global.i18n.translate("client_views_panel_activity").fetch()),c||h.app.view.favicon.newHighlight(),h.app.view.showNotification(this.model.get("name"),e.msg),h.app.view.playSound("highlight")),function(){if(!this.model.isActive()){var e=this.model.tab.find(".activity");e.text((parseInt(e.text(),10)||0)+1),"0"===e.text()?e.addClass("zero"):e.removeClass("zero")}}.apply(this),this.scrollToBottom(),this.msg_count++,this.msg_count>(parseInt(h.global.settings.get("scrollback"),10)||250)&&($(".msg:first",this.$messages).remove(),this.msg_count--)},topic:function(e){"string"==typeof e&&e||(e=this.model.get("topic")),this.model.addMsg("","== "+h.global.i18n.translate("client_views_channel_topic").fetch(this.model.get("name"),e),"topic"),h.app.panels().active===this&&h.app.topicbar.setCurrentTopic(this.model.get("topic"))},nickClick:function(e){var t,n,i,s=$(e.currentTarget).text(),a=this.model.get("members");a&&(t=a.getByNick(s),t&&(n=new h.view.UserBox,n.member=t,n.channel=this.model,a.getByNick(h.app.connections.active_connection.get("nick")).get("is_op")||n.$el.children(".if_op").remove(),i=new h.view.MenuBox(t.get("nick")||"User"),i.addItem("userbox",n.$el),i.show(),function(){var t=e.pageY,n=t+i.$el.outerHeight(),s=this.$el.parent().offset().top+this.$el.parent().outerHeight();n>s&&(t=s-i.$el.outerHeight()),i.$el.offset({left:e.clientX,top:t})}.call(this)))},chanClick:function(e){e.target?h.gateway.join(null,$(e.target).data("channel")):h.gateway.join(null,$(e.srcElement).data("channel"))},mediaClick:function(e){var t,n=$(e.target).parents(".media");n.data("media")?t=n.data("media"):(t=new h.view.MediaMessage({el:n[0]}),n.data("media",t)),t.toggle()},msgEnter:function(e){var t;_.each($(e.currentTarget).parent(".msg").attr("class").split(" "),function(e){e.match(/^nick_[a-z0-9]+/i)&&(t=e)}),t&&$("."+t).addClass("global_nick_highlight")},msgLeave:function(e){var t;_.each($(e.currentTarget).parent(".msg").attr("class").split(" "),function(e){e.match(/^nick_[a-z0-9]+/i)&&(t=e)}),t&&$("."+t).removeClass("global_nick_highlight")}}),h.view.Applet=h.view.Panel.extend({className:"panel applet",initialize:function(e){this.initializePanel(e)}}),h.view.Application=Backbone.View.extend({initialize:function(){var e=this;this.$el=$($("#tmpl_application").html().trim()),this.el=this.$el[0],$(this.model.get("container")||"body").append(this.$el),this.elements={panels:this.$el.find(".panels"),memberlists:this.$el.find(".memberlists"),toolbar:this.$el.find(".toolbar"),controlbox:this.$el.find(".controlbox"),resize_handle:this.$el.find(".memberlists_resize_handle")},$(window).resize(function(){e.doLayout.apply(e)}),this.elements.toolbar.resize(function(){e.doLayout.apply(e)}),this.elements.controlbox.resize(function(){e.doLayout.apply(e)}),h.global.settings.on("change:theme",this.updateTheme,this),this.updateTheme(getQueryVariable("theme")),h.global.settings.on("change:channel_list_style",this.setTabLayout,this),this.setTabLayout(h.global.settings.get("channel_list_style")),h.global.settings.on("change:show_timestamps",this.displayTimestamps,this),this.displayTimestamps(h.global.settings.get("show_timestamps")),this.$el.appendTo($("body")),this.doLayout(),$(document).keydown(this.setKeyFocus),window.onbeforeunload=function(){return h.gateway.isConnected()?h.global.i18n.translate("client_views_application_close_notice").fetch():void 0
},this.has_focus=!0,$(window).on("focus",function(){e.has_focus=!0}),$(window).on("blur",function(){e.has_focus=!1}),this.favicon=new h.view.Favicon,this.initSound()},updateTheme:function(e){e===h.global.settings&&(e=arguments[1]),e||(e=h.global.settings.get("theme")),this.$el.removeClass(function(e,t){return(t.match(/\btheme_\S+/g)||[]).join(" ")}),this.$el.addClass("theme_"+(e||"relaxed"))},setTabLayout:function(e){e===h.global.settings&&(e=arguments[1]),"list"==e?this.$el.addClass("chanlist_treeview"):this.$el.removeClass("chanlist_treeview"),this.doLayout()},displayTimestamps:function(e){e===h.global.settings&&(e=arguments[1]),e?this.$el.addClass("timestamps"):this.$el.removeClass("timestamps")},setKeyFocus:function(e){e.ctrlKey||e.altKey||e.metaKey||"input"===e.target.tagName.toLowerCase()||"textarea"===e.target.tagName.toLowerCase()||$(e.target).attr("contenteditable")||$("#kiwi .controlbox .inp").focus()},doLayout:function(){var e=this.$el,t=this.elements.panels,n=this.elements.memberlists,i=this.elements.toolbar,s=this.elements.controlbox,a=this.elements.resize_handle;if(e.is(":visible")){var o={top:i.outerHeight(!0),bottom:s.outerHeight(!0)};i.is(":visible")||(o.top=0),s.is(":visible")||(o.bottom=0),t.css(o),n.css(o),a.css(o),e.hasClass("chanlist_treeview")&&this.$el.find(".tabs",e).css(o),e.outerWidth()<400?e.addClass("narrow"):e.removeClass("narrow"),"none"!=n.css("display")?(t.css("right",n.outerWidth(!0)),a.css("left",n.position().left-a.outerWidth(!0)/2)):(t.css("right",0),a.css("left",t.outerWidth(!0)));var c=parseInt($("#kiwi .controlbox .input_tools").outerWidth());s.find(".input_wrap").css("right",c+7)}},alertWindow:function(e){this.alertWindowTimer||(this.alertWindowTimer=new function(){var e,t=this,n=!0,i=0,s=h.app.server_settings.client.window_title,a="NCHU IRC Client";this.setTitle=function(e){return e=e||s,window.document.title=e,e},this.start=function(t){n||(a=t,e||(e=setInterval(this.update,1e3)))},this.stop=function(){e&&clearInterval(e),e=null,this.setTitle(),setTimeout(this.reset,2e3)},this.reset=function(){e||t.setTitle()},this.update=function(){0===i?(t.setTitle(a),i=1):(t.setTitle(),i=0)},$(window).focus(function(){n=!0,t.stop(),setTimeout(t.reset,2e3)}),$(window).blur(function(){n=!1})}),this.alertWindowTimer.start(e)},barsHide:function(e){e?(this.$el.find(".toolbar").slideUp(0),$("#kiwi .controlbox").slideUp(0),this.doLayout()):(this.$el.find(".toolbar").slideUp({queue:!1,duration:400,step:$.proxy(this.doLayout,this)}),$("#kiwi .controlbox").slideUp({queue:!1,duration:400,step:$.proxy(this.doLayout,this)}))},barsShow:function(e){e?(this.$el.find(".toolbar").slideDown(0),$("#kiwi .controlbox").slideDown(0),this.doLayout()):(this.$el.find(".toolbar").slideDown({queue:!1,duration:400,step:$.proxy(this.doLayout,this)}),$("#kiwi .controlbox").slideDown({queue:!1,duration:400,step:$.proxy(this.doLayout,this)}))},initSound:function(){var e=this,t=this.model.get("base_path");$script(t+"/assets/libs/soundmanager2/soundmanager2-nodebug-jsmin.js",function(){"undefined"!=typeof soundManager&&soundManager.setup({url:t+"/assets/libs/soundmanager2/",flashVersion:9,preferFlash:!0,onready:function(){e.sound_object=soundManager.createSound({id:"highlight",url:t+"/assets/sound/highlight.mp3"})}})})},playSound:function(e){this.sound_object&&(h.global.settings.get("mute_sounds")||soundManager.play(e))},showNotification:function(e,t){var n=this.model.get("base_path")+"/assets/img/ico.png";window.webkitNotifications&&(this.has_focus||0===webkitNotifications.checkPermission()&&window.webkitNotifications.createNotification(n,e,t).show())}}),h.view.AppToolbar=Backbone.View.extend({events:{"click .settings":"clickSettings"},initialize:function(){},clickSettings:function(){h.app.controlbox.processInput("/settings")}}),h.view.ControlBox=Backbone.View.extend({events:{"keydown .inp":"process","click .nick":"showNickChange"},initialize:function(){var e=this;this.buffer=[],this.buffer_pos=0,this.preprocessor=new i,this.preprocessor.recursive_depth=5,this.tabcomplete={active:!1,data:[],prefix:""},h.app.connections.on("change:nick",function(t){t===h.app.connections.active_connection&&$(".nick",e.$el).text(t.get("nick"))}),h.app.connections.on("active",function(t,n){$(".nick",e.$el).text(n.get("nick"))})},showNickChange:function(){(new h.view.NickChangeBox).render()},process:function(e){var t,n=this,i=$(e.currentTarget),s=i.val();switch(t=-1!==navigator.appVersion.indexOf("Mac")?e.metaKey:e.altKey,this.tabcomplete.active&&9!==e.keyCode&&(this.tabcomplete.active=!1,this.tabcomplete.data=[],this.tabcomplete.prefix=""),!0){case 13===e.keyCode:return s=s.trim(),s&&($.each(s.split("\n"),function(e,t){n.processInput(t)}),this.buffer.push(s),this.buffer_pos=this.buffer.length),i.val(""),!1;case 38===e.keyCode:return this.buffer_pos>0&&(this.buffer_pos--,i.val(this.buffer[this.buffer_pos])),!1;case 40===e.keyCode:this.buffer_pos<this.buffer.length&&(this.buffer_pos++,i.val(this.buffer[this.buffer_pos]));break;case 219===e.keyCode&&t:var a=$("#kiwi .tabs").find("li[class!=connection]"),o=function(){for(var e=0;e<a.length;e++)if($(a[e]).hasClass("active"))return e}();return $prev_tab=0===o?$(a[a.length-1]):$(a[o-1]),$prev_tab.click(),!1;case 221===e.keyCode&&t:var a=$("#kiwi .tabs").find("li[class!=connection]"),o=function(){for(var e=0;e<a.length;e++)if($(a[e]).hasClass("active"))return e}();return $next_tab=o===a.length-1?$(a[0]):$(a[o+1]),$next_tab.click(),!1;case!(9!==e.keyCode||e.shiftKey||e.altKey||e.metaKey||e.ctrlKey):if(this.tabcomplete.active=!0,_.isEqual(this.tabcomplete.data,[])){var c=[],l=h.app.panels().active.get("members");l=l?l.models:[],$.each(l,function(e,t){t&&c.push(t.get("nick"))}),c.push(h.app.panels().active.get("name")),c=_.sortBy(c,function(e){return e}),this.tabcomplete.data=c}return" "===s[i[0].selectionStart-1]?!1:(function(){var e,t,a,o,c,l,r=": ";e=s.substring(0,i[0].selectionStart).split(" "),":"==e[e.length-1]&&e.pop(),e.length>1&&(r=""),l=e[e.length-1],""===this.tabcomplete.prefix&&(this.tabcomplete.prefix=l),this.tabcomplete.data=_.select(this.tabcomplete.data,function(e){return 0===e.toLowerCase().indexOf(n.tabcomplete.prefix.toLowerCase())}),this.tabcomplete.data.length>0&&(a=i[0].selectionStart-l.length,t=s.substr(0,a),o=this.tabcomplete.data.shift(),this.tabcomplete.data.push(o),t+=o,s.substr(i[0].selectionStart,2)!==r&&(t+=r),t+=s.substr(i[0].selectionStart),i.val(t),i[0].setSelectionRange?i[0].setSelectionRange(a+o.length+r.length,a+o.length+r.length):i[0].createTextRange&&(c=i[0].createTextRange(),c.collapse(!0),c.moveEnd("character",a+o.length+r.length),c.moveStart("character",a+o.length+r.length),c.select()))}.apply(this),!1)}},processInput:function(e){var t,n;("/"!==e[0]||"//"===e.substr(0,2))&&(e=e.replace(/^\/\//,"/"),e="/msg "+h.app.panels().active.get("name")+" "+e),this.preprocessor.vars.server=h.app.connections.active_connection.get("name"),this.preprocessor.vars.channel=h.app.panels().active.get("name"),this.preprocessor.vars.destination=this.preprocessor.vars.channel,e=this.preprocessor.process(e),n=e.split(/\s/),"/"===n[0][0]?(t=n[0].substr(1).toLowerCase(),n=n.splice(1,n.length-1)):(t="msg",n.unshift(h.app.panels().active.get("name"))),this.trigger("command",{command:t,params:n}),this.trigger("command:"+t,{command:t,params:n}),this._events["command:"+t]||this.trigger("unknown_command",{command:t,params:n})},addPluginIcon:function(e){var t=$('<div class="tool"></div>').append(e);this.$el.find(".input_tools").append(t),h.app.view.doLayout()}}),h.view.Favicon=Backbone.View.extend({initialize:function(){var e=this,t=$(window);this.has_focus=!0,this.highlight_count=0,this.has_canvas_support=!!window.CanvasRenderingContext2D,this.original_favicon=$('link[rel~="icon"]')[0].href,this._createCanvas(),t.on("focus",function(){e.has_focus=!0,e._resetHighlights()}),t.on("blur",function(){e.has_focus=!1})},newHighlight:function(){var e=this;this.has_focus||(this.highlight_count++,this.has_canvas_support&&this._drawFavicon(function(){e._drawBubble(e.highlight_count.toString()),e._refreshFavicon(e.canvas.toDataURL())}))},_resetHighlights:function(){this.highlight_count=0,this._refreshFavicon(this.original_favicon)},_drawFavicon:function(e){var t=this.canvas,n=t.getContext("2d"),i=new Image;i.crossOrigin="anonymous",i.src=this.original_favicon,i.onload=function(){n.clearRect(0,0,t.width,t.height),n.drawImage(i,0,0,t.width,t.height),e()}},_drawBubble:function(e){var t,n=0,i=0,s=this.canvas,a=test_context=s.getContext("2d"),o=s.width,c=s.height;t=-1!==navigator.appVersion.indexOf("Mac")?-1.5:-1,test_context.font=a.font="bold 10px Arial",test_context.textAlign="right",this._renderText(test_context,e,0,0,t),n=test_context.measureText(e).width+t*(e.length-1)+2,i=9,bubbleX=o-n,bubbleY=c-i,a.fillStyle="red",a.fillRect(bubbleX,bubbleY,n,i),a.fillStyle="white",this._renderText(a,e,o-1,c-1,t)},_refreshFavicon:function(e){$('link[rel~="icon"]').remove(),$('<link rel="shortcut icon" href="'+e+'">').appendTo($("head"))},_createCanvas:function(){var e=document.createElement("canvas");e.width=16,e.height=16,this.canvas=e},_renderText:function(e,t,n,i,s){for(var a,o=t.split("").reverse(),c=0,l=n;c<t.length;)a=o[c++],e.fillText(a,l,i),l+=-1*(e.measureText(a).width+s);return e}}),h.view.MediaMessage=Backbone.View.extend({events:{"click .media_close":"close"},initialize:function(){this.url=this.$el.data("url")},toggle:function(){this.$content&&this.$content.is(":visible")?this.close():this.open()},close:function(){var e=this;this.$content.slideUp("fast",function(){e.$content.remove()})},open:function(){this.$content||(this.$content=$('<div class="media_content"><a class="media_close"><i class="icon-chevron-up"></i> '+h.global.i18n.translate("client_views_mediamessage_close").fetch()+'</a><br /><div class="content"></div></div>'),this.$content.find(".content").append(this.mediaTypes[this.$el.data("type")].apply(this,[])||h.global.i18n.translate("client_views_mediamessage_notfound").fetch()+" :(")),this.$content.is(":visible")||(this.$content.hide(),this.$el.append(this.$content),this.$content.slideDown())},mediaTypes:{twitter:function(){var e=this.$el.data("tweetid"),t=this;return $.getJSON("https://api.twitter.com/1/statuses/oembed.json?id="+e+"&callback=?",function(e){t.$content.find(".content").html(e.html)}),$("<div>"+h.global.i18n.translate("client_views_mediamessage_load_tweet").fetch()+"...</div>")},image:function(){return $('<a href="'+this.url+'" target="_blank"><img height="100" src="'+this.url+'" /></a>')},imgur:function(){var e=this;return $.getJSON("http://api.imgur.com/oembed?url="+this.url,function(t){var n='<a href="'+t.url+'" target="_blank"><img height="100" src="'+t.url+'" /></a>';e.$content.find(".content").html(n)}),$("<div>"+h.global.i18n.translate("client_views_mediamessage_load_image").fetch()+"...</div>")},reddit:function(){var e=this,t=/reddit\.com\/r\/([a-zA-Z0-9_\-]+)\/comments\/([a-z0-9]+)\/([^\/]+)?/gi.exec(this.url);return $.getJSON("http://www."+t[0]+".json?jsonp=?",function(t){console.log("Loaded reddit data",t);var n=t[0].data.children[0].data,i="";n.thumbnail&&(n.over_18?(i="<span class=\"thumbnail_nsfw\" onclick=\"$(this).find('p').remove(); $(this).find('img').css('visibility', 'visible');\">",i+='<p style="font-size:0.9em;line-height:1.2em;cursor:pointer;">Show<br />NSFW</p>',i+='<img src="'+n.thumbnail+'" class="thumbnail" style="visibility:hidden;" />',i+="</span>"):i='<img src="'+n.thumbnail+'" class="thumbnail" />');var s="<div>"+i+"<b><%- title %></b><br />Posted by <%- author %>. &nbsp;&nbsp; ";s+='<i class="icon-arrow-up"></i> <%- ups %> &nbsp;&nbsp; <i class="icon-arrow-down"></i> <%- downs %><br />',s+='<%- num_comments %> comments made. <a href="http://www.reddit.com<%- permalink %>">View post</a></div>',e.$content.find(".content").html(_.template(s,n))}),$("<div>"+h.global.i18n.translate("client_views_mediamessage_load_reddit").fetch()+"...</div>")},youtube:function(){var e=this.$el.data("ytid"),t=this,n='<iframe width="480" height="270" src="https://www.youtube.com/embed/'+e+'?feature=oembed" frameborder="0" allowfullscreen=""></iframe>';return t.$content.find(".content").html(n),$("")},gist:function(){var e=this,t=/https?:\/\/gist\.github\.com\/(?:[a-z0-9-]*\/)?([a-z0-9]+)(\#(.+))?$/i.exec(this.url);return $.getJSON("https://gist.github.com/"+t[1]+".json?callback=?"+(t[2]||""),function(t){$("body").append('<link rel="stylesheet" href="'+t.stylesheet+'" type="text/css" />'),e.$content.find(".content").html(t.div)}),$("<div>"+h.global.i18n.translate("client_views_mediamessage_load_gist").fetch()+"...</div>")}}},{buildHtml:function(e){var t,n="";return e.match(/(\.jpe?g|\.gif|\.bmp|\.png)\??$/i)&&(n+='<span class="media image" data-type="image" data-url="'+e+'" title="Open Image"><a class="open"><i class="icon-chevron-right"></i></a></span>'),t=/imgur\.com\/[^/]*(?!=\.[^!.]+($|\?))/gi.exec(e),t&&!e.match(/(\.jpe?g|\.gif|\.bmp|\.png)\??$/i)&&(n+='<span class="media imgur" data-type="imgur" data-url="'+e+'" title="Open Image"><a class="open"><i class="icon-chevron-right"></i></a></span>'),t=/https?:\/\/twitter.com\/([a-zA-Z0-9_]+)\/status\/([0-9]+)/gi.exec(e),t&&(n+='<span class="media twitter" data-type="twitter" data-url="'+e+'" data-tweetid="'+t[2]+'" title="Show tweet information"><a class="open"><i class="icon-chevron-right"></i></a></span>'),t=/reddit\.com\/r\/([a-zA-Z0-9_\-]+)\/comments\/([a-z0-9]+)\/([^\/]+)?/gi.exec(e),t&&(n+='<span class="media reddit" data-type="reddit" data-url="'+e+'" title="Reddit thread"><a class="open"><i class="icon-chevron-right"></i></a></span>'),t=/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/ ]{11})/gi.exec(e),t&&(n+='<span class="media youtube" data-type="youtube" data-url="'+e+'" data-ytid="'+t[1]+'" title="YouTube Video"><a class="open"><i class="icon-chevron-right"></i></a></span>'),t=/https?:\/\/gist\.github\.com\/(?:[a-z0-9-]*\/)?([a-z0-9]+)(\#(.+))?$/i.exec(e),t&&(n+='<span class="media gist" data-type="gist" data-url="'+e+'" data-gist_id="'+t[1]+'" title="GitHub Gist"><a class="open"><i class="icon-chevron-right"></i></a></span>'),n}}),h.view.Member=Backbone.View.extend({tagName:"li",initialize:function(){this.model.bind("change",this.render,this),this.render()},render:function(){var e=this.$el,t=(this.model.get("modes")||[]).join(" ");return e.attr("class","mode "+t),e.html('<a class="nick"><span class="prefix">'+this.model.get("prefix")+"</span>"+this.model.get("nick")+"</a>"),this}}),h.view.MemberList=Backbone.View.extend({tagName:"ul",events:{"click .nick":"nickClick"},initialize:function(){this.model.bind("all",this.render,this),$(this.el).appendTo("#kiwi .memberlists")},render:function(){var e=this.$el;return e.empty(),this.model.forEach(function(t){t.view.$el.data("member",t),e.append(t.view.$el)}),this},nickClick:function(e){var t,n=$(e.currentTarget).parent("li"),i=n.data("member");t=new h.view.UserBox,t.member=i,t.channel=this.model.channel,this.model.getByNick(h.app.connections.active_connection.get("nick")).get("is_op")||t.$el.children(".if_op").remove();var s=new h.view.MenuBox(i.get("nick")||"User");s.addItem("userbox",t.$el),s.show(),function(){var t=e.pageY,n=t+s.$el.outerHeight(),i=this.$el.parent().offset().top+this.$el.parent().outerHeight(),a=e.pageX,o=a+s.$el.outerWidth(),c=this.$el.parent().offset().left+this.$el.parent().outerWidth();n>i&&(t=i-s.$el.outerHeight()),o>c&&(a=c-s.$el.outerWidth()),s.$el.offset({left:a,top:t})}.call(this)},show:function(){$("#kiwi .memberlists").children().removeClass("active"),$(this.el).addClass("active")}}),h.view.MenuBox=Backbone.View.extend({events:{"click .ui_menu_foot .close, a.close_menu":"dispose"},initialize:function(e){this.$el=$('<div class="ui_menu"></div>'),this._title=e||"",this._items={},this._display_footer=!0,this._close_on_blur=!0},render:function(){var e=this;this.$el.find("*").remove(),this._title&&$('<div class="ui_menu_title"></div>').text(this._title).appendTo(this.$el),_.each(this._items,function(t){var n=$('<div class="ui_menu_content hover"></div>').append(t);e.$el.append(n)}),this._display_footer&&this.$el.append('<div class="ui_menu_foot"><a class="close" onclick="">Close <i class="icon-remove"></i></a></div>')},onDocumentClick:function(e){var t=$(e.target);this._close_on_blur&&t[0]!=this.$el[0]&&0===this.$el.has(t).length&&this.dispose()},dispose:function(){_.each(this._items,function(e){e.dispose&&e.dispose(),e.remove&&e.remove()}),this._items=null,this.remove(),this._close_proxy&&$(document).off("click",this._close_proxy)},addItem:function(e,t){t=$(t),t.is("a")&&t.addClass("icon-chevron-right"),this._items[e]=t},removeItem:function(e){delete this._items[e]},showFooter:function(e){this._display_footer=e},closeOnBlur:function(e){this._close_on_blur=e},show:function(){var e=this;this.render(),this.$el.appendTo(h.app.view.$el),setTimeout(function(){e._close_proxy=function(t){e.onDocumentClick(t)},$(document).on("click",e._close_proxy)},0)}}),h.view.NetworkTabs=Backbone.View.extend({tagName:"ul",className:"connections",initialize:function(){this.model.on("add",this.networkAdded,this),this.model.on("remove",this.networkRemoved,this),this.$el.appendTo(h.app.view.$el.find(".tabs"))},networkAdded:function(e){$('<li class="connection"></li>').append(e.panels.view.$el).appendTo(this.$el)},networkRemoved:function(e){e.panels.view.remove(),h.app.view.doLayout()}}),h.view.NickChangeBox=Backbone.View.extend({events:{submit:"changeNick","click .cancel":"close"},initialize:function(){var e={new_nick:h.global.i18n.translate("client_views_nickchangebox_new").fetch(),change:h.global.i18n.translate("client_views_nickchangebox_change").fetch(),cancel:h.global.i18n.translate("client_views_nickchangebox_cancel").fetch()};this.$el=$(_.template($("#tmpl_nickchange").html().trim(),e))},render:function(){h.app.controlbox.$el.prepend(this.$el),this.$el.find("input").focus(),this.$el.css("bottom",h.app.controlbox.$el.outerHeight(!0))},close:function(){this.$el.remove()},changeNick:function(e){var t=this;return e.preventDefault(),h.app.connections.active_connection.gateway.changeNick(this.$el.find("input").val(),function(){t.close()}),!1}}),h.view.ResizeHandler=Backbone.View.extend({events:{mousedown:"startDrag",mouseup:"stopDrag"},initialize:function(){this.dragging=!1,this.starting_width={},$(window).on("mousemove",$.proxy(this.onDrag,this))},startDrag:function(){this.dragging=!0},stopDrag:function(){this.dragging=!1},onDrag:function(e){this.dragging&&(this.$el.css("left",e.clientX-this.$el.outerWidth(!0)/2),$("#kiwi .memberlists").css("width",this.$el.parent().width()-(this.$el.position().left+this.$el.outerWidth())),h.app.view.doLayout())}}),h.view.ServerSelect=function(){var e="all",t=Backbone.View.extend({events:{"submit form":"submitForm","click .show_more":"showMore","change .have_pass input":"showPass","change .have_key input":"showKey","click .icon-key":"channelKeyIconClick"},initialize:function(){var e={think_nick:h.global.i18n.translate("client_views_serverselect_form_title").fetch(),nickname:h.global.i18n.translate("client_views_serverselect_nickname").fetch(),have_password:h.global.i18n.translate("client_views_serverselect_enable_password").fetch(),password:h.global.i18n.translate("client_views_serverselect_password").fetch(),channel:h.global.i18n.translate("client_views_serverselect_channel").fetch(),channel_key:h.global.i18n.translate("client_views_serverselect_channelkey").fetch(),require_key:h.global.i18n.translate("client_views_serverselect_channelkey_required").fetch(),key:h.global.i18n.translate("client_views_serverselect_key").fetch(),start:h.global.i18n.translate("client_views_serverselect_connection_start").fetch(),server_network:h.global.i18n.translate("client_views_serverselect_server_and_network").fetch(),server:h.global.i18n.translate("client_views_serverselect_server").fetch(),port:h.global.i18n.translate("client_views_serverselect_port").fetch(),powered_by:h.global.i18n.translate("client_views_serverselect_poweredby").fetch()};this.$el=$(_.template($("#tmpl_server_select").html().trim(),e)),h.app.server_settings&&h.app.server_settings.connection&&(h.app.server_settings.connection.allow_change||(this.$el.find(".show_more").remove(),this.$el.addClass("single_server"))),this.more_shown=!1,h.gateway.bind("onconnect",this.networkConnected,this),h.gateway.bind("connecting",this.networkConnecting,this),h.gateway.bind("onirc_error",this.onIrcError,this)},dispose:function(){h.gateway.off("onconnect",this.networkConnected,this),h.gateway.off("connecting",this.networkConnecting,this),h.gateway.off("onirc_error",this.onIrcError,this),this.$el.remove()},submitForm:function(t){return t.preventDefault(),$("input.nick",this.$el).val().trim()?("nick_change"===e?this.submitNickChange(t):this.submitLogin(t),$("button",this.$el).attr("disabled",1),void 0):(this.setStatus(h.global.i18n.translate("client_views_serverselect_nickname_error_empty").fetch()),$("input.nick",this.$el).select(),void 0)},submitLogin:function(){if(!$("button",this.$el).attr("disabled")){var e={nick:$("input.nick",this.$el).val(),server:$("input.server",this.$el).val(),port:$("input.port",this.$el).val(),ssl:$("input.ssl",this.$el).prop("checked"),password:$("input.password",this.$el).val(),channel:$("input.channel",this.$el).val(),channel_key:$("input.channel_key",this.$el).val(),options:this.server_options};this.trigger("server_connect",e)}},submitNickChange:function(){h.gateway.changeNick(null,$("input.nick",this.$el).val()),this.networkConnecting()},showPass:function(){this.$el.find("tr.have_pass input").is(":checked")?this.$el.find("tr.pass").show().find("input").focus():this.$el.find("tr.pass").hide().find("input").val("")},channelKeyIconClick:function(){this.$el.find("tr.have_key input").click()},showKey:function(){this.$el.find("tr.have_key input").is(":checked")?this.$el.find("tr.key").show().find("input").focus():this.$el.find("tr.key").hide().find("input").val("")},showMore:function(){this.more_shown?($(".more",this.$el).slideUp("fast"),$(".show_more",this.$el).children(".icon-caret-up").removeClass("icon-caret-up").addClass("icon-caret-down"),$("input.nick",this.$el).select(),this.more_shown=!1):($(".more",this.$el).slideDown("fast"),$(".show_more",this.$el).children(".icon-caret-down").removeClass("icon-caret-down").addClass("icon-caret-up"),$("input.server",this.$el).select(),this.more_shown=!0)},populateFields:function(e){var t,n,i,s,a,o,c;e=e||{},t=e.nick||"",n=e.server||"",i=e.port||6667,o=e.ssl||0,c=e.password||"",s=e.channel||"",a=e.channel_key||"",$("input.nick",this.$el).val(t),$("input.server",this.$el).val(n),$("input.port",this.$el).val(i),$("input.ssl",this.$el).prop("checked",o),$("input#server_select_show_pass",this.$el).prop("checked",!!c),$("input.password",this.$el).val(c),c&&$("tr.pass",this.$el).show(),$("input.channel",this.$el).val(s),$("input#server_select_show_channel_key",this.$el).prop("checked",!!a),$("input.channel_key",this.$el).val(a),a&&$("tr.key",this.$el).show(),this.server_options={},e.encoding&&(this.server_options.encoding=e.encoding)},hide:function(){this.$el.slideUp()},show:function(t){t=t||"all",this.$el.show(),"all"===t?$(".show_more",this.$el).show():"more"===t?$(".more",this.$el).slideDown("fast"):"nick_change"===t?($(".more",this.$el).hide(),$(".show_more",this.$el).hide(),$("input.nick",this.$el).select()):"enter_password"===t&&($(".more",this.$el).hide(),$(".show_more",this.$el).hide(),$("input.password",this.$el).select()),e=t},infoBoxShow:function(){var e=this.$el.find(".side_panel");e.is(":visible")&&this.$el.animate({width:parseInt(e.css("left"),10)+e.find(".content:first").outerWidth()})},infoBoxHide:function(){var e=this.$el.find(".side_panel");this.$el.animate({width:parseInt(e.css("left"),10)})},infoBoxSet:function(e){this.$el.find(".side_panel .content").empty().append(e)},setStatus:function(e,t){$(".status",this.$el).text(e).attr("class","status").addClass(t||"").show()},clearStatus:function(){$(".status",this.$el).hide()},networkConnected:function(){this.setStatus(h.global.i18n.translate("client_views_serverselect_connection_successfully").fetch()+" :)","ok"),$("form",this.$el).hide()},networkConnecting:function(){this.setStatus(h.global.i18n.translate("client_views_serverselect_connection_trying").fetch(),"ok")},onIrcError:function(e){switch($("button",this.$el).attr("disabled",null),e.error){case"nickname_in_use":this.setStatus(h.global.i18n.translate("client_views_serverselect_nickname_error_alreadyinuse").fetch()),this.show("nick_change"),this.$el.find(".nick").select();break;case"erroneus_nickname":this.setStatus(h.global.i18n.translate("client_views_serverselect_nickname_invalid").fetch()),this.show("nick_change"),this.$el.find(".nick").select();break;case"password_mismatch":this.setStatus(h.global.i18n.translate("client_views_serverselect_password_incorrect").fetch()),this.show("enter_password"),this.$el.find(".password").select()}},showError:function(e){var t=h.global.i18n.translate("client_views_serverselect_connection_error").fetch();if(e)switch(e){case"ENOTFOUND":t=h.global.i18n.translate("client_views_serverselect_server_notfound").fetch();break;case"ECONNREFUSED":t+=" ("+h.global.i18n.translate("client_views_serverselect_connection_refused").fetch()+")";break;default:t+=" ("+e+")"}this.setStatus(t,"error"),$("button",this.$el).attr("disabled",null),this.show()}});return new t(arguments)},h.view.StatusMessage=Backbone.View.extend({initialize:function(){this.$el.hide(),this.tmr=null},text:function(e,t){t=t||{},t.type=t.type||"",t.timeout=t.timeout||5e3,this.$el.text(e).addClass(t.type),this.$el.slideDown($.proxy(h.app.view.doLayout,h.app.view)),t.timeout&&this.doTimeout(t.timeout)},html:function(e,t){t=t||{},t.type=t.type||"",t.timeout=t.timeout||5e3,this.$el.html(e).addClass(t.type),this.$el.slideDown($.proxy(h.app.view.doLayout,h.app.view)),t.timeout&&this.doTimeout(t.timeout)},hide:function(){this.$el.slideUp($.proxy(h.app.view.doLayout,h.app.view))},doTimeout:function(e){this.tmr&&clearTimeout(this.tmr);var t=this;this.tmr=setTimeout(function(){t.hide()},e)}}),h.view.Tabs=Backbone.View.extend({tagName:"ul",className:"panellist",events:{"click li":"tabClick","click li .part":"partClick"},initialize:function(){this.model.on("add",this.panelAdded,this),this.model.on("remove",this.panelRemoved,this),this.model.on("reset",this.render,this),this.model.on("active",this.panelActive,this),this.is_network=!1,this.model.network&&(this.is_network=!0,this.model.network.on("change:name",function(e,t){$("span",this.model.server.tab).text(t)},this))},render:function(){var e=this;this.$el.empty(),this.is_network&&this.model.server.tab.data("panel",this.model.server).data("connection_id",this.model.network.get("connection_id")).appendTo(this.$el),this.model.forEach(function(t){this.is_network&&t==e.model.server||(t.tab.data("panel",t),this.is_network&&t.tab.data("connection_id",this.model.network.get("connection_id")),t.tab.appendTo(e.$el))}),h.app.view.doLayout()},updateTabTitle:function(e,t){$("span",e.tab).text(t)},panelAdded:function(e){e.tab=$("<li><span>"+(e.get("title")||e.get("name"))+'</span><div class="activity"></div></li>'),e.isServer()&&(e.tab.addClass("server"),e.tab.addClass("icon-nonexistant")),e.tab.data("panel",e),this.is_network&&e.tab.data("connection_id",this.model.network.get("connection_id")),e.tab.appendTo(this.$el),e.bind("change:title",this.updateTabTitle),e.bind("change:name",this.updateTabTitle),h.app.view.doLayout()},panelRemoved:function(e){e.tab.remove(),delete e.tab,h.app.view.doLayout()},panelActive:function(e){h.app.view.$el.find(".panellist .part").remove(),h.app.view.$el.find(".panellist .active").removeClass("active"),e.tab.addClass("active"),e.isServer()||e.tab.append('<span class="part icon-nonexistant"></span>')},tabClick:function(e){var t=$(e.currentTarget),n=t.data("panel");n&&n.view.show()},partClick:function(e){var t=$(e.currentTarget).parent(),n=t.data("panel");n&&(n.isChannel()&&n.get("members").models.length>0?this.model.network.gateway.part(n.get("name")):n.close())}}),h.view.TopicBar=Backbone.View.extend({events:{"keydown div":"process"},initialize:function(){h.app.panels.bind("active",function(e){e.isChannel()?(this.setCurrentTopic(e.get("topic")||""),this.$el.find("div").attr("contentEditable",!0)):this.$el.find("div").attr("contentEditable",!1).text("")},this)},process:function(e){var t=$(e.currentTarget),n=t.text();return h.app.panels().active.isChannel()?13===e.keyCode?(h.gateway.topic(null,h.app.panels().active.get("name"),n),!1):void 0:!1},setCurrentTopic:function(e){e=e||"",$("div",this.$el).html(o(_.escape(e)))}}),h.view.UserBox=Backbone.View.extend({events:{"click .query":"queryClick","click .info":"infoClick","click .slap":"slapClick","click .op":"opClick","click .deop":"deopClick","click .voice":"voiceClick","click .devoice":"devoiceClick","click .kick":"kickClick","click .ban":"banClick"},initialize:function(){var e={op:h.global.i18n.translate("client_views_userbox_op").fetch(),de_op:h.global.i18n.translate("client_views_userbox_deop").fetch(),voice:h.global.i18n.translate("client_views_userbox_voice").fetch(),de_voice:h.global.i18n.translate("client_views_userbox_devoice").fetch(),kick:h.global.i18n.translate("client_views_userbox_kick").fetch(),ban:h.global.i18n.translate("client_views_userbox_ban").fetch(),message:h.global.i18n.translate("client_views_userbox_query").fetch(),info:h.global.i18n.translate("client_views_userbox_whois").fetch(),slap:h.global.i18n.translate("client_views_userbox_slap").fetch()};this.$el=$(_.template($("#tmpl_userbox").html().trim(),e))},queryClick:function(){var e=new h.model.Query({name:this.member.get("nick")});h.app.connections.active_connection.panels.add(e),e.view.show()},infoClick:function(){h.app.controlbox.processInput("/whois "+this.member.get("nick"))},slapClick:function(){h.app.controlbox.processInput("/slap "+this.member.get("nick"))},opClick:function(){h.app.controlbox.processInput("/mode "+this.channel.get("name")+" +o "+this.member.get("nick"))},deopClick:function(){h.app.controlbox.processInput("/mode "+this.channel.get("name")+" -o "+this.member.get("nick"))},voiceClick:function(){h.app.controlbox.processInput("/mode "+this.channel.get("name")+" +v "+this.member.get("nick"))},devoiceClick:function(){h.app.controlbox.processInput("/mode "+this.channel.get("name")+" -v "+this.member.get("nick"))},kickClick:function(){h.app.controlbox.processInput("/kick "+this.member.get("nick")+" Bye!")},banClick:function(){h.app.controlbox.processInput("/mode "+this.channel.get("name")+" +b "+this.member.get("nick")+"!*")}})}(window);